<!DOCTYPE html>
<html lang="tr"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Esnaf Glass v3.3</title>
    
    <!-- PWA META TAGS -->
    <meta name="theme-color" content="#000000">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Esnaf Glass">
    <meta name="application-name" content="Esnaf Glass">

    <!-- EMBEDDED ICON -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48cmVjdCB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiIgcng9IjEyMCIgZmlsbD0iIzQzMzhjYSIvPjxwYXRoIGQ9Ik0xNDAgMTMwaDIzMnYyNTJIMTQweiIgZmlsbD0iI2ZmZiIvPjxwYXRoIGQ9Ik0zNzIgMTMwSDMyMHYyNTJoNTJ6IiBmaWxsPSIjZTBlN2ZmIi8+PHBhdGggZD0iTTE0MCAxMzBoNTJ2MjUyaC01MnoiIGZpbGw9IiMzNzMwYTMiIG9wYWNpdHk9IjAuMiIvPjxyZWN0IHg9IjE4NCIgeT0iMTkwIiB3aWR0aD0iMTQ0IiBoZWlnaHQ9IjIwIiByeD0iMTAiIGZpbGw9IiM0MzM4Y2EiIG9wYWNpdHk9IjAuMiIvPjxyZWN0IHg9IjE4NCIgeT0iMjUwIiB3aWR0aD0iODAiIGhlaWdodD0iMjAiIHJ4PSIxMCIgZmlsbD0iIzQzMzhjYSIgb3BhY2l0eT0iMC4yIi8+PC9zdmc+">
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48cmVjdCB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiIgcng9IjEyMCIgZmlsbD0iIzQzMzhjYSIvPjxwYXRoIGQ9Ik0xNDAgMTMwaDIzMnYyNTJIMTQweiIgZmlsbD0iI2ZmZiIvPjxwYXRoIGQ9Ik0zNzIgMTMwSDMyMHYyNTJoNTJ6IiBmaWxsPSIjZTBlN2ZmIi8+PHBhdGggZD0iTTE0MCAxMzBoNTJ2MjUyaC01MnoiIGZpbGw9IiMzNzMwYTMiIG9wYWNpdHk9IjAuMiIvPjxyZWN0IHg9IjE4NCIgeT0iMTkwIiB3aWR0aD0iMTQ0IiBoZWlnaHQ9IjIwIiByeD0iMTAiIGZpbGw9IiM0MzM4Y2EiIG9wYWNpdHk9IjAuMiIvPjxyZWN0IHg9IjE4NCIgeT0iMjUwIiB3aWR0aD0iODAiIGhlaWdodD0iMjAiIHJ4PSIxMCIgZmlsbD0iIzQzMzhjYSIgb3BhY2l0eT0iMC4yIi8+PC9zdmc+">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        
        :root {
            --blue: #0A84FF; --green: #30D158; --red: #FF453A;
            --orange: #FF9F0A; --teal: #64D2FF; --yellow: #FFD60A;
            --indigo: #5E5CE6; --gray: #8E8E93;
            
            --glass-thin: rgba(255, 255, 255, 0.08);
            --glass-border: rgba(255, 255, 255, 0.12);
            --text-primary: #ffffff;
            --text-secondary: rgba(255, 255, 255, 0.6);
            --text-tertiary: rgba(255, 255, 255, 0.35);
            --radius-lg: 24px;
            --safe-bottom: env(safe-area-inset-bottom, 20px);

            /* CLI Colors (Default) */
            --cli-bg: rgba(18, 18, 22, 0.98);
            --cli-green: #00FF41;
            --cli-font: 'Courier New', Courier, monospace;
        }

        /* THEME VARIABLES */
        body.theme-light { background-image: none; background-color: #f2f2f7; color: #000; }
        body.theme-light .glass, body.theme-light .glass-heavy { background: rgba(255,255,255,0.8); border-color: rgba(0,0,0,0.1); box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        body.theme-light .brand { -webkit-text-fill-color: #000; }
        body.theme-light input, body.theme-light select, body.theme-light textarea { background: rgba(0,0,0,0.05); color: #000; border-color: rgba(0,0,0,0.1); }
        body.theme-light .nav-dock { background: rgba(255,255,255,0.9); border-color: rgba(0,0,0,0.1); }
        body.theme-light .nav-item { color: #999; }
        body.theme-light .nav-item.active { color: #000; }
        
        body.theme-matrix { --cli-green: #0f0; }
        body.theme-blue { --cli-green: #00e5ff; --cli-bg: rgba(5, 10, 30, 0.98); }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Inter", sans-serif; }
        
        body { 
            margin: 0; background-color: #000; color: var(--text-primary); 
            min-height: 100vh; padding-bottom: calc(100px + var(--safe-bottom)); 
            overflow-x: hidden; font-size: 16px; user-select: none;
            background-image: 
                radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), 
                radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%), 
                radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%);
            background-attachment: fixed;
            transition: background 0.3s, color 0.3s;
        }

        body::before {
            content: ''; position: fixed; top: -50%; left: -50%; width: 200%; height: 200%;
            background: radial-gradient(circle at 50% 50%, rgba(94, 92, 230, 0.15), transparent 60%),
                        radial-gradient(circle at 80% 20%, rgba(48, 209, 88, 0.1), transparent 50%);
            z-index: -1; animation: drift 20s infinite alternate ease-in-out; pointer-events: none;
        }
        @keyframes drift { 0% { transform: translate(0,0) rotate(0deg); } 100% { transform: translate(-5%, -5%) rotate(5deg); } }

        /* --- GLASS --- */
        .glass {
            background: var(--glass-thin);
            backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
        }
        .glass-heavy {
            background: rgba(28, 28, 30, 0.85);
            backdrop-filter: blur(40px) saturate(180%);
            -webkit-backdrop-filter: blur(40px) saturate(180%);
            border-top: 1px solid rgba(255,255,255,0.15);
        }

        /* --- HEADER --- */
        header { 
            height: calc(60px + env(safe-area-inset-top, 0)); 
            padding: env(safe-area-inset-top, 15px) 20px 10px 20px;
            display: flex; justify-content: space-between; align-items: center; 
            position: sticky; top: 0; z-index: 50;
            background: rgba(0,0,0,0.01); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
        }
        .brand { font-weight: 800; font-size: 1.5rem; letter-spacing: -0.5px; background: linear-gradient(135deg, #fff 0%, #a5f3fc 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; display:flex; align-items:center; gap:8px;}
        .brand::before { content:''; display:inline-block; width:24px; height:24px; background-image: url("data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48cmVjdCB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiIgcng9IjEyMCIgZmlsbD0iIzQzMzhjYSIvPjxwYXRoIGQ9Ik0xNDAgMTMwaDIzMnYyNTJIMTQweiIgZmlsbD0iI2ZmZiIvPjxwYXRoIGQ9Ik0zNzIgMTMwSDMyMHYyNTJoNTJ6IiBmaWxsPSIjZTBlN2ZmIi8+PHBhdGggZD0iTTE0MCAxMzBoNTJ2MjUyaC01MnoiIGZpbGw9IiMzNzMwYTMiIG9wYWNpdHk9IjAuMiIvPjxyZWN0IHg9IjE4NCIgeT0iMTkwIiB3aWR0aD0iMTQ0IiBoZWlnaHQ9IjIwIiByeD0iMTAiIGZpbGw9IiM0MzM4Y2EiIG9wYWNpdHk9IjAuMiIvPjxyZWN0IHg9IjE4NCIgeT0iMjUwIiB3aWR0aD0iODAiIGhlaWdodD0iMjAiIHJ4PSIxMCIgZmlsbD0iIzQzMzhjYSIgb3BhY2l0eT0iMC4yIi8+PC9zdmc+"); background-size:contain; }
        
        .btn-icon { 
            background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.1); 
            color: white; width: 40px; height: 40px; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; position: relative;
        }
        .btn-icon:active { transform: scale(0.9); background: rgba(255,255,255,0.2); }
        .notif-badge { position: absolute; top: -2px; right: -2px; width: 10px; height: 10px; background: var(--red); border-radius: 50%; display: block; border: 2px solid #000; }

        .container { padding: 20px; max-width: 600px; margin: 0 auto; display: none; animation: fadeIn 0.4s cubic-bezier(0.2, 0.8, 0.2, 1); }
        .container.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }

        /* --- CARDS --- */
        .card { border-radius: var(--radius-lg); padding: 24px; margin-bottom: 20px; position: relative; overflow: hidden; transition: transform 0.2s; }
        .card:active { transform: scale(0.99); }
        .card-hero { background: linear-gradient(135deg, rgba(94, 92, 230, 0.6) 0%, rgba(10, 132, 255, 0.3) 100%); border: 1px solid rgba(255,255,255,0.2); }
        .hero-lbl { font-size: 0.7rem; font-weight: 600; color: rgba(255,255,255,0.7); letter-spacing: 1px; text-transform: uppercase; margin-bottom: 4px; }
        .hero-val { font-size: 2.8rem; font-weight: 800; letter-spacing: -1.5px; text-shadow: 0 4px 20px rgba(0,0,0,0.3); margin-bottom: 20px; }
        .hero-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .stat-box { background: rgba(0,0,0,0.2); border-radius: 16px; padding: 12px; text-align: center; backdrop-filter: blur(10px); }
        .stat-lbl { font-size: 0.7rem; color: rgba(255,255,255,0.6); display: block; margin-bottom: 2px; }
        .stat-val { font-weight: 700; font-size: 1.1rem; }

        /* --- GRID & BUTTONS --- */
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-bottom: 24px; }
        .btn-action { 
            background: var(--glass-thin); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            border: 1px solid var(--glass-border); border-radius: 20px;
            padding: 18px 10px; color: white; display: flex; flex-direction: column; align-items: center; gap: 10px;
            font-size: 0.8rem; font-weight: 500; cursor: pointer; transition: 0.2s; 
        }
        .btn-action:active { transform: scale(0.95); background: rgba(255,255,255,0.15); }
        .btn-action i { font-size: 1.8rem; font-style: normal; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.2)); }

        h3 { font-size: 1.2rem; font-weight: 700; margin: 0 0 15px 0; }
        .list-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding: 0 4px; }
        .link-btn { color: var(--blue); font-size: 0.9rem; font-weight: 600; cursor: pointer; }

        .tx-row { display: flex; justify-content: space-between; align-items: center; padding: 16px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .tx-row:last-child { border-bottom: none; }
        /* Reversed (Void) Style */
        .tx-row.reversed { opacity: 0.5; filter: grayscale(1); }
        .tx-row.reversed .tx-desc { text-decoration: line-through; }

        .tx-icon { width: 48px; height: 48px; border-radius: 16px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; margin-right: 16px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); flex-shrink: 0; }
        .tx-desc { font-weight: 600; font-size: 1rem; margin-bottom: 2px; }
        .tx-meta { font-size: 0.75rem; color: var(--text-tertiary); }
        .tx-amt { font-weight: 700; font-size: 1.1rem; letter-spacing: -0.5px; }

        /* --- CONTACTS --- */
        #contact-search { background: rgba(255,255,255,0.1); border: none; padding: 14px 16px; border-radius: 12px; color: white; font-size: 1rem; width: 100%; backdrop-filter: blur(10px); margin-bottom: 20px; }
        .contact-item { display: flex; justify-content: space-between; align-items: center; padding: 16px; background: var(--glass-thin); border: 1px solid var(--glass-border); border-radius: 18px; margin-bottom: 10px; backdrop-filter: blur(10px); }
        .avatar { width: 42px; height: 42px; background: linear-gradient(135deg, #8E8E93, #636366); border-radius: 50%; display:flex; align-items:center; justify-content:center; font-weight:700; margin-right:12px; font-size:0.9rem; }
        .badge { padding: 6px 10px; border-radius: 8px; font-size: 0.7rem; font-weight: 700; letter-spacing: 0.5px; }
        .badge-green { background: rgba(48, 209, 88, 0.2); color: var(--green); border: 1px solid rgba(48, 209, 88, 0.3); }
        .badge-red { background: rgba(255, 69, 58, 0.2); color: var(--red); border: 1px solid rgba(255, 69, 58, 0.3); }

        /* --- DOCK NAV --- */
        .nav-wrapper { position: fixed; bottom: 25px; left: 0; width: 100%; display: flex; justify-content: center; z-index: 100; pointer-events: none; }
        .nav-dock { pointer-events: auto; background: rgba(40, 40, 40, 0.75); backdrop-filter: blur(25px) saturate(150%); -webkit-backdrop-filter: blur(25px) saturate(150%); border: 1px solid rgba(255,255,255,0.15); border-radius: 32px; padding: 10px 20px; display: flex; gap: 25px; box-shadow: 0 15px 40px rgba(0,0,0,0.4); }
        .nav-item { display: flex; flex-direction: column; align-items: center; cursor: pointer; color: var(--text-tertiary); transition: 0.3s; position: relative; width: 44px; }
        .nav-item span:first-child { font-size: 1.6rem; margin-bottom: 2px; filter: grayscale(100%); transition: 0.3s; }
        .nav-lbl { font-size: 0.6rem; font-weight: 600; opacity: 0; transform: translateY(5px); transition: 0.3s; }
        .nav-item.active { color: white; transform: translateY(-5px); }
        .nav-item.active span:first-child { filter: grayscale(0%); text-shadow: 0 0 15px rgba(255,255,255,0.5); }
        .nav-item.active .nav-lbl { opacity: 1; transform: translateY(0); }
        .fab { position: absolute; top: -30px; left: 50%; transform: translateX(-50%); width: 56px; height: 56px; border-radius: 50%; background: linear-gradient(135deg, var(--blue), var(--indigo)); display: flex; align-items: center; justify-content: center; font-size: 1.8rem; color: white; box-shadow: 0 8px 20px rgba(10, 132, 255, 0.5); border: 2px solid rgba(255,255,255,0.2); cursor: pointer; transition: 0.2s; z-index: 10; }
        .fab:active { transform: translateX(-50%) scale(0.9); }

        /* --- MODALS --- */
        .modal-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); z-index: 200; 
            display: none; align-items: flex-end; justify-content: center;
            opacity: 0; transition: opacity 0.3s ease; padding-bottom: env(safe-area-inset-bottom, 0);
        }
        .modal-overlay.active { display: flex; opacity: 1; }
        
        .modal { 
            width: 100%; max-width: 600px; max-height: 85vh; 
            display: flex; flex-direction: column;
            border-radius: 32px 32px 0 0; 
            border-top: 1px solid rgba(255,255,255,0.2);
            box-shadow: 0 -10px 50px rgba(0,0,0,0.6);
            transform: translateY(100%);
            transition: transform 0.35s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .modal.open { transform: translateY(0); }
        .modal.dragging { transition: none; }

        .drag-handle-zone {
            width: 100%; padding: 20px 0 10px 0; flex-shrink: 0;
            display: flex; justify-content: center; align-items: flex-start;
            cursor: grab; touch-action: none;
        }
        .modal-grabber { width: 40px; height: 5px; background: rgba(255,255,255,0.3); border-radius: 3px; }
        
        .modal-content-scroll {
            overflow-y: auto; padding: 0 24px 40px 24px;
            -ms-overflow-style: none; scrollbar-width: none;
            overscroll-behavior-y: contain;
        }
        .modal-content-scroll::-webkit-scrollbar { display: none; }

        /* --- FORMS & BUTTONS --- */
        input, select, textarea { width: 100%; padding: 18px; border-radius: 16px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); color: white; font-size: 16px; margin-bottom: 8px; transition: 0.2s; appearance: none; }
        input:focus, select:focus, textarea:focus { background: rgba(0,0,0,0.5); border-color: var(--blue); box-shadow: 0 0 0 4px rgba(10, 132, 255, 0.15); }
        label { color: var(--text-secondary); font-size: 0.85rem; font-weight: 600; margin-left: 5px; margin-bottom: 6px; display: block; }
        
        .btn-main { width: 100%; padding: 18px; border-radius: 18px; border: none; font-weight: 700; font-size: 1.05rem; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; margin-top: 10px; transition: transform 0.1s; flex-shrink: 0; }
        .btn-main:active { transform: scale(0.97); }
        .btn-primary { background: linear-gradient(135deg, #007AFF, #0055FF); color: white; }
        .btn-success { background: linear-gradient(135deg, #34C759, #30B753); color: white; }
        .btn-danger { background: linear-gradient(135deg, #FF3B30, #FF2D55); color: white; }
        .btn-glass { background: rgba(255,255,255,0.1); color: white; border:1px solid rgba(255,255,255,0.1); }

        .seg-control { background: rgba(0,0,0,0.3); padding: 4px; border-radius: 16px; display: flex; margin-bottom: 24px; flex-shrink: 0; }
        .seg-opt { flex: 1; text-align: center; padding: 10px; font-size: 0.9rem; color: rgba(255,255,255,0.5); border-radius: 12px; transition: 0.2s; font-weight: 600; cursor: pointer; }
        .seg-opt.active { background: rgba(255,255,255,0.15); color: white; box-shadow: 0 2px 8px rgba(0,0,0,0.2); }

        .chips-container { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 15px; }
        .chip { background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.1); color: var(--text-secondary); padding: 8px 16px; border-radius: 20px; font-size: 0.85rem; cursor: pointer; transition:0.2s; }
        .chip:active, .chip.active { background: var(--blue); color: white; border-color: var(--blue); }

        .chart-wrapper { margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1); }
        .bar-container { display: flex; align-items: flex-end; justify-content: space-between; height: 120px; }
        .bar-col { flex: 1; display: flex; flex-direction: column; justify-content: flex-end; align-items: center; height: 100%; padding: 0 4px; }
        .bar { width: 80%; background: rgba(255,255,255,0.1); border-radius: 6px; min-height: 6px; transition: height 0.8s; }
        .bar.filled { background: linear-gradient(to top, var(--blue), var(--teal)); box-shadow: 0 0 10px var(--blue); }
        .bar-lbl { font-size: 0.65rem; color: var(--text-tertiary); margin-top: 8px; font-weight: 600; }

        .text-green { color: var(--green); text-shadow: 0 0 10px rgba(48, 209, 88, 0.4); }
        .text-red { color: var(--red); text-shadow: 0 0 10px rgba(255, 69, 58, 0.4); }
        .warning-box { background: rgba(255, 159, 10, 0.15); border: 1px solid rgba(255, 159, 10, 0.4); color: var(--orange); padding: 15px; border-radius: 16px; display: none; align-items: center; gap: 12px; margin-bottom: 20px; }
        .warning-box.active { display: flex; }
        .settings-tabs { display: flex; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 20px; }
        .settings-tab-btn { flex: 1; text-align: center; padding: 12px; font-weight: 600; color: var(--text-tertiary); border-bottom: 2px solid transparent; }
        .settings-tab-btn.active { color: white; border-bottom-color: white; }
        .settings-pane { display: none; }
        .settings-pane.active { display: block; }
        
        #filter-indicator { font-size:0.75rem; background:rgba(10,132,255,0.2); color:var(--blue); padding:4px 10px; border-radius:8px; display:none; align-items:center; gap:5px; border:1px solid rgba(10,132,255,0.3); margin-left: 10px; }

        /* --- CLI OVERLAY (MOBILE OPTIMIZED) --- */
        #cli-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--cli-bg);
            z-index: 9999;
            display: none; flex-direction: column;
            font-family: var(--cli-font); font-size: 14px;
            color: var(--cli-green);
            backdrop-filter: blur(15px);
        }
        #cli-layer.active { display: flex; animation: slideDown 0.25s ease-out; }
        @keyframes slideDown { from{transform:translateY(-100%);} to{transform:translateY(0);} }

        /* Header */
        #cli-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px 20px; border-bottom: 1px solid rgba(0,255,65,0.2);
            background: rgba(0,0,0,0.3);
        }
        .cli-title { font-weight: bold; letter-spacing: 1px; color: #fff; }
        .cli-close { 
            background: transparent; border: 1px solid var(--cli-green); 
            color: var(--cli-green); padding: 8px 16px; border-radius: 8px; 
            font-family: inherit; font-weight: bold; cursor: pointer;
        }

        /* Output Area - Improved Flow */
        #cli-output {
            flex: 1; overflow-y: auto; padding: 15px;
            display: flex; flex-direction: column; justify-content: flex-end;
            white-space: pre-wrap; word-break: break-word;
            scroll-behavior: smooth; font-size: 13px;
            overscroll-behavior: contain;
        }
        .cli-log { margin-bottom: 8px; line-height: 1.4; border-left: 2px solid transparent; padding-left: 8px; flex-shrink: 0; }
        .cli-log.user { color: #fff; font-weight: bold; border-left-color: #fff; background: rgba(255,255,255,0.05); padding: 5px 8px; border-radius: 0 4px 4px 0; }
        .cli-log.success { color: var(--cli-green); border-left-color: var(--cli-green); }
        .cli-log.error { color: var(--red); border-left-color: var(--red); }
        .cli-log.info { color: var(--teal); border-left-color: var(--teal); }
        
        /* Mobile Suggestion Bar */
        #cli-suggestions {
            display: flex; gap: 10px; padding: 12px 15px;
            overflow-x: auto; background: rgba(30,30,35,0.9);
            border-top: 1px solid rgba(255,255,255,0.1);
            white-space: nowrap; min-height: 55px; align-items: center;
            -webkit-overflow-scrolling: touch;
        }
        .cli-chip {
            background: rgba(0, 255, 65, 0.1); border: 1px solid var(--cli-green);
            color: var(--cli-green); padding: 10px 18px; border-radius: 12px;
            font-size: 14px; cursor: pointer; font-weight: bold; user-select: none;
        }
        .cli-chip:active { background: var(--cli-green); color: #000; }
        .cli-hint { color: #888; font-size: 12px; margin-left: auto; font-style: italic; }

        /* Input Area */
        #cli-input-wrapper {
            display: flex; align-items: center; padding: 15px;
            background: rgba(0,0,0,0.8); border-top: 1px solid rgba(255,255,255,0.1);
            padding-bottom: max(15px, env(safe-area-inset-bottom));
        }
        #cli-prompt { margin-right: 10px; color: #fff; font-weight: bold; font-size: 16px; }
        #cli-input {
            flex: 1; background: transparent; border: none; color: #fff;
            font-family: var(--cli-font); font-size: 16px; padding: 0; margin: 0;
            outline: none; border-radius: 0;
        }
        #cli-input::placeholder { color: rgba(255,255,255,0.2); font-style: italic; }
        
        /* Tables in CLI */
        .cli-table { width: 100%; border-collapse: collapse; margin-top: 5px; font-size: 12px; }
        .cli-table th { text-align: left; border-bottom: 1px dashed var(--cli-green); color: #fff; padding: 4px; }
        .cli-table td { border-bottom: 1px solid rgba(255,255,255,0.1); padding: 4px; color: rgba(255,255,255,0.8); }
    </style>
</head>
<body>

<header>
    <div class="brand">Esnaf Glass</div>
    <div style="display:flex; gap:15px;">
        <button class="btn-icon" onclick="toggleCLI()">üíª</button>
        <button class="btn-icon" onclick="openSettings()">
            ‚öôÔ∏è
            <div id="settings-badge" class="notif-badge" style="display:none;"></div>
        </button>
    </div>
</header>

<!-- CLI OVERLAY -->
<div id="cli-layer">
    <div id="cli-header">
        <span class="cli-title">TERMINAL v1.5</span>
        <button class="cli-close" onclick="toggleCLI()">KAPAT</button>
    </div>
    <div id="cli-output">
        <div class="cli-log info">Esnaf Glass CLI v1.5</div>
        <div class="cli-log info">Logs will appear here at the bottom.</div>
    </div>
    
    <!-- Suggestion Chips for Mobile -->
    <div id="cli-suggestions"></div>
    
    <div id="cli-input-wrapper">
        <span id="cli-prompt">‚ûú</span>
        <input type="text" id="cli-input" placeholder="Komut..." autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
    </div>
</div>

<div id="view-home" class="container active">
    <div class="card card-hero glass">
        <div class="hero-lbl">NET VARLIK</div>
        <div class="hero-val" id="dash-net">‚Ç∫0</div>
        <div class="hero-stats">
            <div class="stat-box">
                <span class="stat-lbl">KASA</span>
                <span class="stat-val text-green" id="dash-cash">‚Ç∫0</span>
            </div>
            <div class="stat-box" onclick="openEditStock()">
                <span class="stat-lbl">STOK ‚úèÔ∏è</span>
                <span class="stat-val" style="color:var(--teal)" id="dash-stock">‚Ç∫0</span>
            </div>
        </div>
    </div>
    <div class="grid-3">
        <button class="btn-action glass" onclick="openModal('modal-income')"><i style="color:var(--green)">üí∞</i> Satƒ±≈ü</button>
        <button class="btn-action glass" onclick="openModal('modal-buy')"><i style="color:var(--blue)">üì¶</i> Mal Al</button>
        <button class="btn-action glass" onclick="openModal('modal-expense')"><i style="color:var(--red)">üìâ</i> Gider</button>
    </div>
    <div class="card glass">
        <div class="list-header"><h3>Son Hareketler</h3><span class="link-btn" onclick="switchTab('history')">T√ºm√º ‚Ä∫</span></div>
        <div id="recent-list"><div class="empty-state">Hen√ºz i≈ülem yok.</div></div>
    </div>
</div>

<div id="view-contacts" class="container">
    <input type="text" id="contact-search" placeholder="üîç M√º≈üteri ara..." onkeyup="renderContacts()">
    <div id="contact-list"></div>
    <div style="margin-top: 20px;"><button class="btn-main btn-primary" onclick="openModal('modal-add-contact')">+ Yeni Ki≈üi Ekle</button></div>
</div>

<div id="view-history" class="container">
    <div class="list-header">
        <div style="display:flex; align-items:center;">
            <h3 style="margin:0;">ƒ∞≈ülem Ge√ßmi≈üi</h3>
            <div id="filter-indicator"><span>üîç</span> Filtreli</div>
        </div>
        <button class="btn-icon" style="width:auto; height:32px; padding:0 12px; font-size:0.85rem; border-radius:12px; font-weight:600;" onclick="openModal('modal-filter')">Filtrele üîΩ</button>
    </div>

    <div id="history-summary" style="display:none; background:rgba(10, 132, 255, 0.15); padding:15px; border-radius:16px; margin-bottom:15px; border:1px solid rgba(10, 132, 255, 0.3);">
        <div style="display:flex; justify-content:space-between; font-weight:700; font-size:1rem; color:var(--blue);">
            <span>Giri≈ü: <span id="sum-in">0</span></span><span>√áƒ±kƒ±≈ü: <span id="sum-out">0</span></span>
        </div>
    </div>
    <div id="full-history-list"></div>
</div>

<div id="view-report" class="container">
    <div class="card glass">
        <div class="list-header"><h3>Bu Ayƒ±n Tahmini</h3><span style="font-size:0.75rem; background:rgba(255, 214, 10, 0.2); color:var(--yellow); padding:4px 8px; border-radius:6px;">Kar Marjƒ±: %<span id="lbl-margin">30</span></span></div>
        <div class="grid-3" style="grid-template-columns:1fr 1fr; gap:15px;">
            <div style="background:rgba(48, 209, 88, 0.1); padding:15px; border-radius:18px; text-align:center;">
                <div style="font-size:0.7rem; font-weight:700; color:var(--green); margin-bottom:5px; text-transform:uppercase;">Ciro</div>
                <div style="font-size:1.1rem; font-weight:800; color:var(--green);" id="rep-ciro">‚Ç∫0</div>
            </div>
            <div style="background:rgba(255, 69, 58, 0.1); padding:15px; border-radius:18px; text-align:center;">
                <div style="font-size:0.7rem; font-weight:700; color:var(--red); margin-bottom:5px; text-transform:uppercase;">Gider</div>
                <div style="font-size:1.1rem; font-weight:800; color:var(--red);" id="rep-exp">‚Ç∫0</div>
            </div>
        </div>
        <div style="text-align:center; margin-top:20px; padding-top:20px; border-top:1px solid rgba(255,255,255,0.1);">
            <div style="font-size:0.85rem; color:var(--text-secondary); font-weight:600;">TAHMƒ∞Nƒ∞ NET KAR</div>
            <div style="font-size: 2.4rem; font-weight: 900; letter-spacing: -1px; color: var(--green); text-shadow: rgba(255, 255, 255, 0.3) 0px 0px 20px;" id="rep-net">‚Ç∫0</div>
        </div>
        <div class="chart-wrapper"><div class="bar-container" id="weekly-chart"><div class="bar-col"><div class="bar " style="height:0%;"></div><div class="bar-lbl">Cum</div></div><div class="bar-col"><div class="bar " style="height:0%;"></div><div class="bar-lbl">Cmt</div></div><div class="bar-col"><div class="bar " style="height:0%;"></div><div class="bar-lbl">Paz</div></div><div class="bar-col"><div class="bar " style="height:0%;"></div><div class="bar-lbl">Pzt</div></div><div class="bar-col"><div class="bar " style="height:0%;"></div><div class="bar-lbl">Sal</div></div><div class="bar-col"><div class="bar " style="height:0%;"></div><div class="bar-lbl">√áar</div></div><div class="bar-col"><div class="bar " style="height:0%;"></div><div class="bar-lbl">Per</div></div></div></div>
    </div>
    <div class="card glass">
        <h3 style="margin:0 0 15px 0; font-size:1.1rem;">Piyasa Durumu</h3>
        <div class="tx-row"><span>Alacaklar (Piyasa)</span><span class="text-green" style="font-size:1.1rem; font-weight:700;" id="rep-rec">‚Ç∫0</span></div>
        <div class="tx-row"><span>Bor√ßlar (Tedarik√ßi)</span><span class="text-red" style="font-size:1.1rem; font-weight:700;" id="rep-debt">‚Ç∫0</span></div>
    </div>
</div>

<div class="nav-wrapper">
    <div class="nav-dock glass-heavy">
        <div class="nav-item active" onclick="switchTab('home', this)"><span>üè†</span><span class="nav-lbl">√ñzet</span></div>
        <div class="nav-item" onclick="switchTab('contacts', this)"><span>üë•</span><span class="nav-lbl">Ki≈üiler</span></div>
        <div style="width:20px; position:relative;"><div class="fab" onclick="openModal('modal-income')"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg></div></div>
        <div class="nav-item" onclick="switchTab('history', this)"><span>üìú</span><span class="nav-lbl">Ge√ßmi≈ü</span></div>
        <div class="nav-item" onclick="switchTab('report', this)"><span>üìä</span><span class="nav-lbl">Analiz</span></div>
    </div>
</div>

<!-- OTHER MODALS -->
<div id="modal-filter" class="modal-overlay">
    <div class="modal glass-heavy">
        <div class="drag-handle-zone"><div class="modal-grabber"></div></div>
        <div class="modal-content-scroll">
            <h3>üîç Filtreleme Se√ßenekleri</h3>
            
            <div class="chips-container" style="margin-bottom:15px;">
                <div class="chip" onclick="setQuickDate('today')">Bug√ºn</div>
                <div class="chip" onclick="setQuickDate('week')">Bu Hafta</div>
                <div class="chip" onclick="setQuickDate('month')">Bu Ay</div>
            </div>

            <div class="grid-3" style="grid-template-columns:1fr 1fr; margin-bottom:12px;">
                <div><label>Ba≈ülangƒ±√ß</label><input type="date" id="f-start"></div>
                <div><label>Biti≈ü</label><input type="date" id="f-end"></div>
            </div>
            
            <div style="margin-bottom:12px;">
                <label>ƒ∞≈ülem Tipi</label>
                <select id="f-type">
                    <option value="all">T√ºm√º</option>
                    <option value="ciro">Satƒ±≈ü (Pe≈üin)</option>
                    <option value="veresiye_satis">Satƒ±≈ü (Veresiye)</option>
                    <option value="gider">Gider</option>
                    <option value="mal">Mal Alƒ±mƒ±</option>
                </select>
            </div>
            <div style="margin-bottom:20px;"><label>Ki≈üi / Firma</label><select id="f-contact"><option value="all">Herkes</option></select></div>
            
            <div class="grid-3" style="grid-template-columns:1fr 1fr; gap:15px;">
                <button class="btn-main btn-glass" onclick="clearFilter()">TEMƒ∞ZLE</button>
                <button class="btn-main btn-primary" onclick="applyFilter()">UYGULA</button>
            </div>
        </div>
    </div>
</div>

<div id="modal-income" class="modal-overlay">
    <div class="modal glass-heavy">
        <div class="drag-handle-zone"><div class="modal-grabber"></div></div>
        <div class="modal-content-scroll">
            <h3>üí∞ Satƒ±≈ü / Giri≈ü</h3>
            <div class="seg-control">
                <div class="seg-opt active" onclick="setIncomeType('ciro', this)">√úr√ºn Satƒ±≈üƒ±</div>
                <div class="seg-opt" onclick="setIncomeType('sermaye', this)">Kasa Ekle</div>
            </div>
            <label>Tutar (‚Ç∫)</label>
            <input type="number" id="inp-inc-amt" placeholder="0" style="font-size:2rem; text-align:center; font-weight:800; color:var(--green); margin-bottom:20px; background:transparent; border:none; border-bottom:1px solid rgba(255,255,255,0.2);" inputmode="decimal">
            <div id="inc-details">
                <label>√ñdeme Tipi</label>
                <select id="inp-inc-method" onchange="toggleContactSelect('inc', this.value)">
                    <option value="pesin">Pe≈üin</option>
                    <option value="veresiye">Veresiye (Ki≈üi Se√ß)</option>
                </select>
                <div id="div-inc-contact" style="display:none; margin-top:15px;"><label>M√º≈üteri Se√ßiniz</label><select id="inp-inc-contact"><option value="">Se√ßiniz...</option></select></div>
            </div>
            <button class="btn-main btn-success" style="margin-top:24px;" onclick="saveIncome()">Gƒ∞Rƒ∞≈ûƒ∞ KAYDET</button>
        </div>
    </div>
</div>

<div id="modal-buy" class="modal-overlay">
    <div class="modal glass-heavy">
        <div class="drag-handle-zone"><div class="modal-grabber"></div></div>
        <div class="modal-content-scroll">
            <h3>üì¶ Mal Alƒ±mƒ±</h3>
            <label>Tutar (‚Ç∫)</label>
            <input type="number" id="inp-buy-amt" placeholder="0" style="font-size:2rem; text-align:center; font-weight:800; color:var(--blue); margin-bottom:20px; background:transparent; border:none; border-bottom:1px solid rgba(255,255,255,0.2);" inputmode="decimal">
            <label>√ñdeme ≈ûekli</label>
            <select id="inp-buy-method" onchange="toggleContactSelect('buy', this.value)">
                <option value="pesin">Pe≈üin (Kasadan √ñde)</option>
                <option value="veresiye">Veresiye (Borca Yaz)</option>
            </select>
            <div id="div-buy-contact" style="display:none; margin-top:15px;"><label>Tedarik√ßi Se√ßiniz</label><select id="inp-buy-contact"><option value="">Se√ßiniz...</option></select></div>
            <button class="btn-main btn-primary" style="margin-top:24px;" onclick="saveBuy()">STOK EKLE</button>
        </div>
    </div>
</div>

<div id="modal-expense" class="modal-overlay">
    <div class="modal glass-heavy">
        <div class="drag-handle-zone"><div class="modal-grabber"></div></div>
        <div class="modal-content-scroll">
            <h3>üìâ Gider √áƒ±kƒ±≈üƒ±</h3>
            <label>Tutar (‚Ç∫)</label>
            <input type="number" id="inp-exp-amt" placeholder="0" style="font-size:2rem; text-align:center; font-weight:800; color:var(--red); margin-bottom:20px; background:transparent; border:none; border-bottom:1px solid rgba(255,255,255,0.2);" inputmode="decimal">
            <label>A√ßƒ±klama</label>
            <div id="expense-chips" class="chips-container"></div>
            <input type="text" id="inp-exp-desc" placeholder="Kira, Fatura vb." list="expense-suggestions" autocomplete="off">
            <datalist id="expense-suggestions"></datalist>
            <button class="btn-main btn-danger" style="margin-top:24px;" onclick="saveExpense()">KAYDET</button>
        </div>
    </div>
</div>

<div id="modal-add-contact" class="modal-overlay">
    <div class="modal glass-heavy">
        <div class="drag-handle-zone"><div class="modal-grabber"></div></div>
        <div class="modal-content-scroll">
            <h3>Yeni Ki≈üi / Firma</h3>
            <label>Ad Soyad / Firma √únvanƒ±</label>
            <input type="text" id="inp-c-name" placeholder="√ñrn: Toptancƒ± Ahmet">
            <button class="btn-main btn-primary" style="margin-top:24px;" onclick="addContact()">OLU≈ûTUR</button>
        </div>
    </div>
</div>

<div id="modal-contact-op" class="modal-overlay">
    <div class="modal glass-heavy">
        <div class="drag-handle-zone"><div class="modal-grabber"></div></div>
        <div class="modal-content-scroll">
            <h3 id="op-c-name" style="text-align:center; margin-bottom:5px;"></h3>
            <div id="op-c-bal" style="text-align:center; font-weight:800; font-size:1.4rem; margin-bottom:24px;"></div>
            <button class="btn-action" style="width:100%; margin-bottom:24px; flex-direction:row; justify-content:center; padding:12px; background:rgba(255,255,255,0.05);" onclick="showContactHistoryFromModal()"><span>üìú</span> Bu Ki≈üinin Hesap D√∂k√ºm√º (Ekstre)</button>
            <div style="background:rgba(255,255,255,0.05); padding:15px; border-radius:16px; margin-bottom:20px;">
                <label style="text-align:center;">ƒ∞≈ülem Tutarƒ±</label>
                <input type="number" id="inp-op-amt" style="text-align:center; font-size:1.5rem; background:transparent; border:none;" inputmode="decimal" placeholder="0">
            </div>
            <div class="grid-3" style="grid-template-columns:1fr 1fr; gap:15px;">
                <button class="btn-main" style="background:var(--orange); color:white;" onclick="doContactOp('give')">Bor√ß Ver<br><small>(√ñdeme)</small></button>
                <button class="btn-main btn-success" onclick="doContactOp('take')">Tahsilat<br><small>(Bor√ß Al)</small></button>
            </div>
            <button class="btn-main" style="margin-top:20px; background:rgba(255,59,48,0.2); color:var(--red);" onclick="deleteContact()">Ki≈üiyi Sil</button>
        </div>
    </div>
</div>

<div id="modal-stock-edit" class="modal-overlay">
    <div class="modal glass-heavy">
        <div class="drag-handle-zone"><div class="modal-grabber"></div></div>
        <div class="modal-content-scroll">
            <h3>Stok Deƒüeri D√ºzenle</h3>
            <input type="number" id="inp-stock-val" inputmode="decimal" style="font-size:1.5rem; text-align:center; font-weight:bold;">
            <button class="btn-main btn-primary" style="margin-top:24px;" onclick="updateStockVal()">G√úNCELLE</button>
        </div>
    </div>
</div>

<div id="modal-settings" class="modal-overlay active">
    <div class="modal glass-heavy open">
        <div class="drag-handle-zone"><div class="modal-grabber"></div></div>
        <div class="modal-content-scroll">
            <h3>Ayarlar</h3>
            <div class="settings-tabs">
                <div class="settings-tab-btn" onclick="switchSettingsTab('genel', this)">Genel</div>
                <div class="settings-tab-btn" onclick="switchSettingsTab('yedek', this)">Yedekleme</div>
                <div class="settings-tab-btn active" onclick="switchSettingsTab('sistem', this)">Sistem</div>
            </div>
            <div id="pane-genel" class="settings-pane">
                <button class="btn-main btn-glass" style="font-size:0.9rem; margin-bottom:20px;" onclick="showInstallHelp()">üì≤ Ana Ekrana Ekle</button>
                <div style="margin-bottom:20px;"><label>Ortalama Kar Marjƒ± (%)</label><input type="number" id="inp-settings-margin" placeholder="30"></div>
                <div style="margin-bottom:10px;"><label>‚ö†Ô∏è Yedekleme Hatƒ±rlatƒ±cƒ±sƒ±</label>
                <select id="inp-settings-reminder">
                    <option value="0">Kapalƒ±</option>
                    <option value="5">Her 5 ƒ∞≈ülemde Bir</option>
                    <option value="10">Her 10 ƒ∞≈ülemde Bir</option>
                    <option value="20">Her 20 ƒ∞≈ülemde Bir</option>
                    <option value="50">Her 50 ƒ∞≈ülemde Bir</option>
                </select>
                </div>
                <button class="btn-main btn-primary" style="margin-top:15px;" onclick="saveSettings()">KAYDET</button>
            </div>
            <div id="pane-yedek" class="settings-pane">
                 <div id="backup-warning" class="warning-box"><span>‚ö†Ô∏è</span><div><b>Yedek Almalƒ±sƒ±n!</b><br><span id="backup-count-lbl">0</span> i≈ülem oldu.</div></div>
                <button class="btn-action" style="width:100%; margin-bottom:15px; flex-direction:row; justify-content:center;" onclick="backupToClipboard()">üìã T√ºm Veriyi Kopyala</button>
                <div class="grid-3" style="grid-template-columns:1fr 1fr; gap:10px;">
                    <button class="btn-action" onclick="backupDownload()">üíæ ƒ∞ndir (JSON)</button>
                    <button class="btn-action" onclick="exportCSV()">üìä Excel (CSV)</button>
                    <div style="position:relative;" class="btn-action"><span>üìÇ Y√ºkle</span><input type="file" onchange="restoreBackup(this)" accept=".json,.txt" style="opacity:0; position:absolute; top:0; left:0; width:100%; height:100%;"></div>
                </div>
                <textarea id="restore-text-area" rows="3" placeholder="Yedek kodunu buraya yapƒ±≈ütƒ±r..." style="width:100%; padding:10px; font-size:0.8rem; margin-top:10px;"></textarea>
                <button class="btn-main btn-success" style="margin-top:10px;" onclick="restoreFromText()">üì• Y√ºkle</button>
            </div>
            <div id="pane-sistem" class="settings-pane active">
                <button class="btn-main btn-glass" style="margin-bottom:20px;" onclick="downloadAppSource()">üì• Uygulamayƒ± ƒ∞ndir (.html)</button>
                <button class="btn-main btn-danger" onclick="hardReset()">VERƒ∞LERƒ∞ SIFIRLA</button>
            </div>
        </div>
    </div>
</div>

<script>
/* --- V3.1 IMMUTABLE LOGIC --- */
let db={cash:0,stock:0,profitMargin:30,contacts:[],history:[],txCount:0,backupLimit:10},tempIncomeType='ciro',selectedCId=null;
let activeFilter = false;

window.onload=()=>{
    const s=localStorage.getItem('esnaf_v4_db');if(s)try{db=JSON.parse(s)}catch(e){}if(!db.profitMargin)db.profitMargin=30;if(db.txCount===undefined)db.txCount=0;initApp();initSwipeGestures();
    if('serviceWorker' in navigator){navigator.serviceWorker.register(URL.createObjectURL(new Blob(["self.addEventListener('install',e=>self.skipWaiting());self.addEventListener('fetch',e=>e.respondWith(fetch(e.request)));"],{type:'application/javascript'}))).catch(()=>console.log('SW Skipped'));}
    initCLIListener();
};
function initApp(){if(!Array.isArray(db.contacts))db.contacts=[];if(!Array.isArray(db.history))db.history=[];updateUI();}
function saveDB(){localStorage.setItem('esnaf_v4_db',JSON.stringify(db));updateUI();}
function updateUI(){
    checkBackupStatus();
    const tr=db.contacts.reduce((a,c)=>a+(c.balance>0?c.balance:0),0);
    const td=db.contacts.reduce((a,c)=>a+(c.balance<0?Math.abs(c.balance):0),0);
    const n=db.cash+db.stock+tr-td;
    document.getElementById('dash-net').innerText=fmt(n);
    document.getElementById('dash-cash').innerText=fmt(db.cash);
    document.getElementById('dash-stock').innerText=fmt(db.stock);
    document.getElementById('lbl-margin').innerText=db.profitMargin;
    
    const now=new Date(),days=[];
    for(let i=6;i>=0;i--){const d=new Date();d.setDate(now.getDate()-i);days.push({date:d.toISOString().slice(0,10),label:d.toLocaleDateString('tr-TR',{weekday:'short'}),val:0});}
    
    let mc=0,me=0,mg=0;
    const cm=now.toISOString().slice(0,7);
    
    db.history.forEach(h=>{
        const isCurrentMonth = h.date.startsWith(cm);

        if(h.type==='ciro' || h.type==='veresiye_satis'){
            if(isCurrentMonth) { mc+=h.amount; mg+=h.cost||0; }
            const dx=days.findIndex(d=>d.date===h.date.slice(0,10)); if(dx>-1) days[dx].val+=h.amount;
        }
        else if(h.type==='gider'){
            if(isCurrentMonth) me+=h.amount;
        }
        else if(h.type==='iade_satis' || h.type==='iade_veresiye'){
            if(isCurrentMonth) { mc-=h.amount; mg-=h.cost||0; }
            const dx=days.findIndex(d=>d.date===h.date.slice(0,10)); if(dx>-1) days[dx].val-=h.amount;
        }
        else if(h.type==='iade_gider'){
            if(isCurrentMonth) me-=h.amount;
        }
    });

    document.getElementById('rep-ciro').innerText=fmt(mc);
    document.getElementById('rep-exp').innerText=fmt(me);
    const np=(mc-mg)-me;
    const ne=document.getElementById('rep-net');
    ne.innerText=fmt(np);
    ne.style.color=np>=0?'var(--green)':'var(--red)';
    document.getElementById('rep-rec').innerText=fmt(tr);
    document.getElementById('rep-debt').innerText=fmt(td);
    drawChart(days);

    const rd=document.getElementById('recent-list');
    rd.innerHTML=db.history.length?'':'<div class="empty-state">Hen√ºz i≈ülem yok.</div>';
    db.history.slice(0,5).forEach(h=>rd.innerHTML+=createHistoryRow(h));
    populateSelects();
    if(document.getElementById('view-history').classList.contains('active'))applyFilter();
}

function populateSelects(){const o='<option value="">Se√ßiniz...</option>'+db.contacts.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');document.getElementById('inp-inc-contact').innerHTML=o;document.getElementById('inp-buy-contact').innerHTML=o;document.getElementById('f-contact').innerHTML='<option value="all">Herkes</option>'+db.contacts.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');}
function drawChart(d){const m=Math.max(...d.map(x=>x.val),1);document.getElementById('weekly-chart').innerHTML=d.map(x=>`<div class="bar-col"><div class="bar ${x.val>0?'filled':''}" style="height:${Math.max(0, (x.val/m)*100)}%;"></div><div class="bar-lbl">${x.label}</div></div>`).join('');}
function saveIncome(){const a=getNum('inp-inc-amt');if(a<=0)return;if(tempIncomeType==='ciro'){const c=a*((100-db.profitMargin)/100);db.stock-=c;const m=document.getElementById('inp-inc-method').value;if(m==='pesin'){db.cash+=a;addHistory('ciro',a,'Pe≈üin Satƒ±≈ü',c);}else{const i=document.getElementById('inp-inc-contact').value;if(!i)return;const k=db.contacts.find(x=>x.id===i);k.balance+=a;addHistory('veresiye_satis',a,`Satƒ±≈ü: ${k.name}`,c,i);}}else{db.cash+=a;addHistory('sermaye',a,'Sermaye Giri≈üi');}closeModal(document.querySelector('.modal-overlay.active').id);saveDB();}
function saveBuy(){const a=getNum('inp-buy-amt');if(a<=0)return;db.stock+=a;const m=document.getElementById('inp-buy-method').value;if(m==='pesin'){db.cash-=a;addHistory('mal',a,'Mal Alƒ±mƒ± (Pe≈üin)');}else{const i=document.getElementById('inp-buy-contact').value;if(!i)return;const k=db.contacts.find(x=>x.id===i);k.balance-=a;addHistory('mal_cari',a,`Mal Alƒ±mƒ±: ${k.name}`,null,i);}closeModal(document.querySelector('.modal-overlay.active').id);saveDB();}
function saveExpense(){const a=getNum('inp-exp-amt');if(a<=0)return;db.cash-=a;addHistory('gider',a,document.getElementById('inp-exp-desc').value||'Gider');closeModal(document.querySelector('.modal-overlay.active').id);saveDB();}
function addContact(){const n=document.getElementById('inp-c-name').value.trim();if(!n)return;db.contacts.push({id:Date.now().toString(),name:n,balance:0});closeModal('modal-add-contact');saveDB();renderContacts();}
function renderContacts(){const l=document.getElementById('contact-list'),t=(document.getElementById('contact-search').value||'').toLowerCase();l.innerHTML='';[...db.contacts].sort((a,b)=>Math.abs(b.balance)-Math.abs(a.balance)).forEach(c=>{if(t&&!c.name.toLowerCase().includes(t))return;let b=c.balance>0?`<span class="badge badge-green">ALACAK: ${fmt(c.balance)}</span>`:(c.balance<0?`<span class="badge badge-red">BOR√á: ${fmt(Math.abs(c.balance))}</span>`:`<span class="badge" style="background:rgba(255,255,255,0.1)">TEMƒ∞Z</span>`);l.innerHTML+=`<div class="contact-item" onclick="openContactModal('${c.id}')"><div style="display:flex; align-items:center;"><div class="avatar">${c.name.charAt(0).toUpperCase()}</div><span style="font-weight:600;">${c.name}</span></div>${b}</div>`;});}
function doContactOp(t){const a=getNum('inp-op-amt');if(a<=0)return;const c=db.contacts.find(x=>x.id===selectedCId);if(t==='give'){db.cash-=a;c.balance+=a;addHistory('cari_cikis',a,`${c.name} (√ñdeme)`,null,c.id);}else{db.cash+=a;c.balance-=a;addHistory('cari_giris',a,`${c.name} (Tahsilat)`,null,c.id);}closeModal('modal-contact-op');saveDB();}

/* --- NEW HISTORY ROW & REVERSE LOGIC --- */
function createHistoryRow(h,d=false){
    const p=['ciro','sermaye','cari_giris','veresiye_satis','iade_mal','iade_gider'].includes(h.type);
    const c=p?'var(--green)':'var(--red)';
    let i='üîπ';
    if(h.type.includes('ciro')||h.type.includes('satis')) i='üí∞';
    if(h.type.includes('gider')) i='üìâ';
    if(h.type.includes('mal')) i='üì¶';
    if(h.type.includes('iade')||h.type.includes('iptal')) i='‚Ü©Ô∏è';

    let b='';
    if(d && !h.isReversed && !h.type.includes('iade') && !h.type.includes('iptal')){
        b=`<button onclick="reverseTx('${h.id}')" style="margin-left:10px; background:rgba(255,255,255,0.1); color:#fff; border:none; border-radius:8px; width:36px; height:36px; font-size:1.2rem;">‚Ü©Ô∏è</button>`;
    }

    const classes = `tx-row ${h.isReversed ? 'reversed' : ''}`;
    const desc = h.isReversed ? `<span style="color:var(--red)">[ƒ∞PTAL]</span> ${h.desc}` : h.desc;

    return `<div class="${classes}"><div style="display:flex; align-items:center;"><div class="tx-icon">${i}</div><div><div class="tx-desc">${desc}</div><div class="tx-meta">${new Date(h.date).toLocaleDateString()} ${new Date(h.date).toLocaleTimeString().slice(0,5)}</div></div></div><div style="display:flex; align-items:center;"><span class="tx-amt" style="color:${c}">${p?'+':'-'}${fmt(h.amount)}</span>${b}</div></div>`;
}

function reverseTx(id){
    if(!confirm('Bu i≈ülem geri alƒ±narak ters kayƒ±t olu≈üturulacak. Onaylƒ±yor musun?')) return;
    const tx = db.history.find(h=> String(h.id) === String(id));
    if(!tx) { alert("ƒ∞≈ülem bulunamadƒ±."); return; }
    if(tx.isReversed) return;

    tx.isReversed = true;
    const amt = tx.amount;
    const cost = tx.cost || 0;
    
    if(tx.type === 'ciro') { db.cash -= amt; db.stock += cost; addHistory('iade_satis', amt, `ƒ∞ade/ƒ∞ptal: ${tx.desc}`, cost); }
    else if(tx.type === 'veresiye_satis') { const c = db.contacts.find(x=>x.id === tx.contactId); if(c) c.balance -= amt; db.stock += cost; addHistory('iade_veresiye', amt, `ƒ∞ade/ƒ∞ptal: ${tx.desc}`, cost, tx.contactId); }
    else if(tx.type === 'gider') { db.cash += amt; addHistory('iade_gider', amt, `ƒ∞ptal: ${tx.desc}`); }
    else if(tx.type === 'mal') { db.cash += amt; db.stock -= amt; addHistory('iade_mal', amt, `ƒ∞ade: ${tx.desc}`); }
    else if(tx.type === 'mal_cari') { const c = db.contacts.find(x=>x.id === tx.contactId); if(c) c.balance += amt; db.stock -= amt; addHistory('iade_mal_cari', amt, `ƒ∞ade: ${tx.desc}`, null, tx.contactId); }
    else if(tx.type === 'cari_giris') { const c = db.contacts.find(x=>x.id === tx.contactId); if(c) c.balance += amt; db.cash -= amt; addHistory('iptal_tahsilat', amt, `ƒ∞ptal: ${tx.desc}`, null, tx.contactId); }
    else if(tx.type === 'cari_cikis') { const c = db.contacts.find(x=>x.id === tx.contactId); if(c) c.balance -= amt; db.cash += amt; addHistory('iptal_odeme', amt, `ƒ∞ptal: ${tx.desc}`, null, tx.contactId); }
    else if(tx.type === 'sermaye') { db.cash -= amt; addHistory('iptal_sermaye', amt, `ƒ∞ptal: ${tx.desc}`); }

    saveDB();
    if(document.getElementById('view-history').classList.contains('active')) applyFilter();
}

function openModal(id){document.querySelectorAll(`#${id} input`).forEach(e=>e.value='');if(document.querySelector(`#${id} select`))document.querySelector(`#${id} select`).selectedIndex=0;['div-inc-contact','div-buy-contact'].forEach(d=>{if(document.getElementById(d))document.getElementById(d).style.display='none'});document.getElementById(id).classList.add('active');setTimeout(()=>document.querySelector(`#${id} .modal`).classList.add('open'),10);if(id==='modal-expense')updateExpenseSuggestions();if(id==='modal-settings'){document.getElementById('inp-settings-margin').value=db.profitMargin;document.getElementById('inp-settings-reminder').value=db.backupLimit||10;} if(id==='modal-filter' && activeFilter){/*Keep existing filter values*/}}
function closeModal(id){document.querySelector(`#${id} .modal`).classList.remove('open');document.querySelector(`#${id}`).style.opacity='0';setTimeout(()=>{document.getElementById(id).classList.remove('active');document.getElementById(id).style.opacity='';},300);}
function getNum(id){return parseFloat(document.getElementById(id).value)||0;}
function fmt(n){return new Intl.NumberFormat('tr-TR',{style:'currency',currency:'TRY',maximumFractionDigits:0}).format(n);}
function addHistory(t,a,d,c=null,i=null){db.history.unshift({id:Date.now(),date:new Date().toISOString(),type:t,amount:a,desc:d,cost:c,contactId:i,isReversed:false});db.txCount=(db.txCount||0)+1;}
function updateExpenseSuggestions(){const c=document.getElementById('expense-chips');c.innerHTML='';['Kira','Fatura','Yemek','Yol','Malzeme'].forEach(t=>c.innerHTML+=`<div class="chip" onclick="document.getElementById('inp-exp-desc').value='${t}'">${t}</div>`);}
function switchTab(i,e){document.querySelectorAll('.container').forEach(c=>c.classList.remove('active'));document.getElementById('view-'+i).classList.add('active');document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));if(e)e.classList.add('active');if(i==='contacts'){document.getElementById('contact-search').value='';renderContacts();}if(i==='history')applyFilter();window.scrollTo(0,0);}
function switchSettingsTab(p,b){document.querySelectorAll('.settings-pane').forEach(x=>x.classList.remove('active'));document.getElementById('pane-'+p).classList.add('active');document.querySelectorAll('.settings-tab-btn').forEach(x=>x.classList.remove('active'));b.classList.add('active');}
function openContactModal(i){selectedCId=i;const c=db.contacts.find(x=>x.id===i);document.getElementById('op-c-name').innerText=c.name;const e=document.getElementById('op-c-bal');e.innerText=fmt(c.balance);e.style.color=c.balance>0?'var(--green)':(c.balance<0?'var(--red)':'white');openModal('modal-contact-op');}
function showContactHistoryFromModal(){closeModal('modal-contact-op');document.getElementById('f-contact').value=selectedCId;switchTab('history');activeFilter=true;applyFilter();}
function deleteContact(){if(confirm('Silinsin mi?')){db.contacts=db.contacts.filter(x=>x.id!==selectedCId);saveDB();closeModal('modal-contact-op');renderContacts();}}
function openEditStock(){document.getElementById('inp-stock-val').value=db.stock;openModal('modal-stock-edit');}
function updateStockVal(){db.stock=getNum('inp-stock-val');saveDB();closeModal('modal-stock-edit');}
function openSettings(){openModal('modal-settings');}
function saveSettings(){db.profitMargin=getNum('inp-settings-margin');db.backupLimit=parseInt(document.getElementById('inp-settings-reminder').value);saveDB();closeModal('modal-settings');}
function hardReset(){if(confirm('Her ≈üey silinecek!')){localStorage.clear();location.reload();}}
function checkBackupStatus(){const w=document.getElementById('backup-warning'),b=document.getElementById('settings-badge');document.getElementById('backup-count-lbl').innerText=db.txCount;if(db.backupLimit>0&&db.txCount>=db.backupLimit){w.classList.add('active');b.style.display='flex';}else{w.classList.remove('active');b.style.display='none';}}

/* EXPORT CSV */
function exportCSV() {
    let csv = "Tarih,Tip,Aciklama,Tutar,KisiID,IptalDurumu\n";
    db.history.forEach(h => {
        csv += `${h.date},${h.type},"${h.desc}",${h.amount},${h.contactId||''},${h.isReversed?'IPTAL':''}\n`;
    });
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    const url = URL.createObjectURL(blob);
    link.setAttribute("href", url);
    link.setAttribute("download", `esnaf_dokum_${new Date().toISOString().slice(0,10)}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

/* BACKUP/RESTORE */
function resetBackupCounter() { db.txCount = 0; saveDB(); }
async function backupToClipboard() { const json = JSON.stringify(db, null, 2); try { await navigator.clipboard.writeText(json); resetBackupCounter(); alert("Kopyalandƒ±! Notlara veya WhatsApp'a yapƒ±≈ütƒ±rabilirsin."); } catch(e) { const ta = document.createElement('textarea'); ta.value = json; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); resetBackupCounter(); alert("Kopyalandƒ±! (Yedek Y√∂ntem)"); } }
function backupDownload() { const json = JSON.stringify(db, null, 2); const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([json],{type:'application/json'})); a.download=`esnaf_yedek_${new Date().toISOString().slice(0,10)}.json`; a.click(); resetBackupCounter(); }
function restoreBackup(i){ const r=new FileReader(); r.onload=e=>{ processRestoreData(e.target.result); }; r.readAsText(i.files[0]); }
function restoreFromText(){ const txt = document.getElementById('restore-text-area').value; if(!txt) return alert('Metin kutusu bo≈ü!'); processRestoreData(txt); }
function processRestoreData(rawString) { try { let cleanString = rawString.trim(); if (cleanString.charCodeAt(0) === 0xFEFF) cleanString = cleanString.slice(1); const data = JSON.parse(cleanString); if (data && typeof data === 'object') { if(confirm('Mevcut veriler silinip yedek y√ºklensin mi?')) { if (!Array.isArray(data.contacts)) data.contacts = []; if (!Array.isArray(data.history)) data.history = []; if (typeof data.cash !== 'number') data.cash = 0; if (typeof data.stock !== 'number') data.stock = 0; db = data; saveDB(); alert('Ba≈üarƒ±yla y√ºklendi! Sayfa yenileniyor...'); setTimeout(() => location.reload(), 1000); } } else { alert('Ge√ßersiz veri!'); } } catch(e) { alert('Hata! Veri bozuk veya hatalƒ± kopyalanmƒ±≈ü.'); } }
function showInstallHelp(){alert('IOS: Payla≈ü -> Ana Ekrana Ekle\nAndroid: Men√º -> Uygulamayƒ± Y√ºkle / Ana Ekrana Ekle');}
function downloadAppSource(){const a=document.createElement('a');a.href=URL.createObjectURL(new Blob(["<!DOCTYPE html>\n"+document.documentElement.outerHTML],{type:"text/html"}));a.download="esnaf_glass_v2_mobile_cli.html";a.click();}
function setIncomeType(t,e){tempIncomeType=t;document.querySelectorAll('.seg-opt').forEach(s=>s.classList.remove('active'));e.classList.add('active');document.getElementById('inc-details').style.display=t==='ciro'?'block':'none';}
function toggleContactSelect(c,v){document.getElementById(`div-${c}-contact`).style.display=v==='veresiye'?'block':'none';}

/* FILTER LOGIC */
function applyFilter(){const s=document.getElementById('f-start').value,e=document.getElementById('f-end').value,t=document.getElementById('f-type').value,c=document.getElementById('f-contact').value;let l=[...db.history];if(s)l=l.filter(h=>h.date.slice(0,10)>=s);if(e)l=l.filter(h=>h.date.slice(0,10)<=e);if(t!=='all')l=l.filter(h=>h.type===t);if(c!=='all')l=l.filter(h=>h.contactId===c);l.sort((a,b)=>new Date(b.date)-new Date(a.date));const o=document.getElementById('full-history-list');o.innerHTML=l.length?'':'<div class="empty-state">Kayƒ±t yok.</div>';let i=0,ot=0;l.forEach(h=>{if(['ciro','sermaye','cari_giris','veresiye_satis'].includes(h.type))i+=h.amount;else if(['iade_satis','iade_veresiye','iade_gider','iade_mal','iptal_tahsilat','iptal_odeme'].includes(h.type)){/* Netting happens in UI */ } else ot+=h.amount;o.innerHTML+=createHistoryRow(h,true);});document.getElementById('sum-in').innerText=fmt(i);document.getElementById('sum-out').innerText=fmt(ot);document.getElementById('history-summary').style.display='block'; activeFilter = (s || e || t!=='all' || c!=='all'); document.getElementById('filter-indicator').style.display = activeFilter ? 'flex' : 'none'; closeModal('modal-filter');}
function clearFilter(){document.getElementById('f-start').value='';document.getElementById('f-end').value='';document.getElementById('f-type').value='all';document.getElementById('f-contact').value='all';applyFilter();}
function setQuickDate(r) { const n = new Date(); const y = n.getFullYear(), m = String(n.getMonth()+1).padStart(2,'0'), d = String(n.getDate()).padStart(2,'0'); if(r === 'today') { const s = `${y}-${m}-${d}`; document.getElementById('f-start').value = s; document.getElementById('f-end').value = s; } if(r === 'month') { document.getElementById('f-start').value = `${y}-${m}-01`; document.getElementById('f-end').value = `${y}-${m}-${new Date(y, n.getMonth()+1, 0).getDate()}`; } if(r === 'week') { const f = new Date(n.setDate(n.getDate() - n.getDay() + 1)); const l = new Date(n.setDate(n.getDate() - n.getDay() + 7)); document.getElementById('f-start').value = f.toISOString().slice(0,10); document.getElementById('f-end').value = l.toISOString().slice(0,10); } }
function initSwipeGestures() { const handles = document.querySelectorAll('.drag-handle-zone'); handles.forEach(h => { let startY = 0; let currentModal = null; let overlay = null; h.addEventListener('touchstart', (e) => { startY = e.touches[0].clientY; currentModal = h.closest('.modal'); overlay = h.closest('.modal-overlay'); currentModal.classList.add('dragging'); }, {passive: true}); h.addEventListener('touchmove', (e) => { if(!currentModal) return; const deltaY = e.touches[0].clientY - startY; if(deltaY > 0) { currentModal.style.transform = `translateY(${deltaY}px)`; const opacity = Math.max(0, 1 - (deltaY / 400)); overlay.style.backgroundColor = `rgba(0,0,0,${0.5 * opacity})`; } }, {passive: true}); h.addEventListener('touchend', (e) => { if(!currentModal) return; const deltaY = e.changedTouches[0].clientY - startY; currentModal.classList.remove('dragging'); currentModal.style.transform = ''; overlay.style.backgroundColor = ''; if(deltaY > 120) { closeModal(overlay.id); } else { currentModal.classList.add('open'); } currentModal = null; overlay = null; }); }); document.querySelectorAll('.modal-overlay').forEach(o => { o.addEventListener('click', (e) => { if(e.target === o) closeModal(o.id); }); }); }

/* ---------------------------------------------------------
   STRICT CLI IMPLEMENTATION (MOBILE OPTIMIZED)
   --------------------------------------------------------- */
const CLI = {
    isOpen: false,
    history: [],
    histPtr: -1,
    // Strict Command Definition
    commands: {
        'help': { desc: 'Show manual', args: '' },
        'clear': { desc: 'Clear terminal', args: '' },
        'status': { desc: 'Show financial status', args: '' },
        'stats': { desc: 'Show analytics', args: '' },
        'theme': { desc: 'Set theme (dark, light, matrix, blue)', args: '<name>' },
        'add': { 
            desc: 'Add record', 
            sub: {
                'income': { args: '<amt> [-p|-v <name>] [desc]', desc: 'Add income/sale' },
                'expense': { args: '<amt> "<desc>"', desc: 'Add expense' },
                'buy': { args: '<amt> [-p|-v <name>] [desc]', desc: 'Add stock/buy' },
                'contact': { args: '"<name>"', desc: 'Create new contact' }
            }
        },
        'pay': {
            desc: 'Debt management',
            sub: {
                'give': { args: '<name> <amt> [desc]', desc: 'Pay debt to contact' },
                'take': { args: '<name> <amt> [desc]', desc: 'Collect from contact' }
            }
        },
        'list': {
            desc: 'List data',
            sub: {
                'contacts': { args: '', desc: 'List all contacts' },
                'history': { args: '[limit]', desc: 'List recent transactions' }
            }
        },
        'reverse': { desc: 'Reverse/Void Transaction', args: '<id>' },
        'del': {
            desc: 'Delete items',
            sub: {
                'contact': { args: '<id>', desc: 'Delete contact by ID' }
            }
        },
        'set': {
            desc: 'Settings',
            sub: {
                'margin': { args: '<percent>', desc: 'Set profit margin' },
                'stock': { args: '<amount>', desc: 'Overwrite stock value' }
            }
        },
        'backup': {
            desc: 'Data management',
            sub: {
                'copy': { args: '', desc: 'Copy DB to clipboard' },
                'download': { args: '', desc: 'Download DB file' },
                'view': { args: '', desc: 'Show raw JSON' }
            }
        },
        'restore': { desc: 'Paste JSON data', args: '' },
        'reset': { desc: 'Wipe all data', args: 'yes' },
        'calc': { desc: 'Calculator', args: '<expression>' },
        'time': { desc: 'Current time', args: '' }
    }
};

// CLI Logic Hooks
function toggleCLI() {
    const el = document.getElementById('cli-layer');
    const inp = document.getElementById('cli-input');
    CLI.isOpen = !CLI.isOpen;
    el.classList.toggle('active', CLI.isOpen);
    if (CLI.isOpen) {
        inp.value = '';
        inp.focus();
        renderSuggestions('');
    }
}

function initCLIListener() {
    const inp = document.getElementById('cli-input');
    
    document.addEventListener('keydown', (e) => {
        if (e.key === '~' || e.key === '"') { e.preventDefault(); toggleCLI(); }
    });

    inp.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            const val = inp.value.trim();
            if (val) {
                cliLog(`‚ûú ${val}`, 'user');
                CLI.history.push(val);
                CLI.histPtr = CLI.history.length;
                cliExecute(val);
                inp.value = '';
                renderSuggestions('');
            }
        }
        else if (e.key === 'ArrowUp') {
            e.preventDefault();
            if (CLI.history.length > 0 && CLI.histPtr > 0) {
                CLI.histPtr--;
                inp.value = CLI.history[CLI.histPtr];
            }
        }
        else if (e.key === 'ArrowDown') {
            e.preventDefault();
            if (CLI.histPtr < CLI.history.length - 1) {
                CLI.histPtr++;
                inp.value = CLI.history[CLI.histPtr];
            } else {
                CLI.histPtr = CLI.history.length;
                inp.value = '';
            }
        }
        else if (e.key === 'Tab') {
             e.preventDefault();
             const suggestions = document.querySelectorAll('.cli-chip');
             if(suggestions.length > 0) suggestions[0].click();
        }
    });

    inp.addEventListener('input', (e) => {
        renderSuggestions(e.target.value);
    });
}

function renderSuggestions(val) {
    const cont = document.getElementById('cli-suggestions');
    cont.innerHTML = '';
    
    const parts = val.trim().split(' ');
    const main = parts[0];
    const sub = parts[1];
    
    let suggestions = [];

    if (parts.length <= 1) {
        suggestions = Object.keys(CLI.commands).filter(k => k.startsWith(main));
    } 
    else if (parts.length === 2 && CLI.commands[main] && CLI.commands[main].sub) {
        suggestions = Object.keys(CLI.commands[main].sub).filter(s => s.startsWith(sub));
    }
    
    if (suggestions.length > 0) {
        suggestions.forEach(s => {
            const chip = document.createElement('div');
            chip.className = 'cli-chip';
            chip.innerText = s;
            chip.onclick = () => {
                if (parts.length <= 1) {
                    document.getElementById('cli-input').value = s + ' ';
                } else {
                    document.getElementById('cli-input').value = main + ' ' + s + ' ';
                }
                document.getElementById('cli-input').focus();
                renderSuggestions(document.getElementById('cli-input').value);
            };
            cont.appendChild(chip);
        });
    } else if (parts.length >= 2 && CLI.commands[main] && CLI.commands[main].sub && CLI.commands[main].sub[parts[1]]) {
        const hint = document.createElement('div');
        hint.className = 'cli-hint';
        hint.innerText = `Args: ${CLI.commands[main].sub[parts[1]].args.join(' ')}`;
        cont.appendChild(hint);
    }
}

function cliLog(msg, type='success') {
    const out = document.getElementById('cli-output');
    const div = document.createElement('div');
    div.className = `cli-log ${type}`;
    div.innerHTML = msg;
    out.appendChild(div);
    out.scrollTop = out.scrollHeight;
}

function cliTable(headers, rows) {
    let h = '<table class="cli-table"><thead><tr>';
    headers.forEach(hed => h += `<th>${hed}</th>`);
    h += '</tr></thead><tbody>';
    rows.forEach(row => {
        h += '<tr>';
        row.forEach(col => h += `<td>${col}</td>`);
        h += '</tr>';
    });
    h += '</tbody></table>';
    const out = document.getElementById('cli-output');
    const div = document.createElement('div');
    div.innerHTML = h;
    out.appendChild(div);
    out.scrollTop = out.scrollHeight;
}

function cliFindContact(nameOrId) {
    const c = db.contacts.find(x => x.id === nameOrId || x.name.toLowerCase() === nameOrId.toLowerCase());
    if (!c) throw new Error(`Contact '${nameOrId}' not found.`);
    return c;
}

/* CORE EXECUTOR */
async function cliExecute(line) {
    const args = line.match(/(?:[^\s"]+|"[^"]*")+/g).map(a => a.replace(/"/g, ''));
    const cmd = args.shift();

    try {
        if (!CLI.commands[cmd]) throw new Error('Command not found.');

        if (cmd === 'help') {
            let txt = "";
            for (let k in CLI.commands) {
                const c = CLI.commands[k];
                if (c.sub) {
                    for (let s in c.sub) txt += `<div style="margin-bottom:4px"><b style="color:#fff">${k} ${s}</b> <span style="color:#888">${c.sub[s].args}</span><br>‚Ü≥ ${c.sub[s].desc}</div>`;
                } else {
                    txt += `<div style="margin-bottom:4px"><b style="color:#fff">${k}</b> <span style="color:#888">${c.args}</span><br>‚Ü≥ ${c.desc}</div>`;
                }
            }
            cliLog(txt, 'info');
            return;
        }

        if (cmd === 'clear') { document.getElementById('cli-output').innerHTML = ''; return; }
        if (cmd === 'time') { cliLog(new Date().toLocaleString('tr-TR'), 'info'); return; }

        if (cmd === 'theme') {
            const t = args[0];
            if(['dark','light','matrix','blue'].includes(t)) {
                document.body.className = `theme-${t}`;
                cliLog(`Theme changed to ${t}`, 'success');
            } else {
                cliLog('Themes: dark, light, matrix, blue', 'error');
            }
            return;
        }

        if (cmd === 'status') {
            cliLog(`CASH: ${fmt(db.cash)}<br>STOCK: ${fmt(db.stock)}<br>TX: ${db.txCount}`, 'success');
            return;
        }

        if (cmd === 'stats') {
             const today = new Date().toISOString().slice(0,10);
             const sales = db.history.filter(h => h.date.startsWith(today) && (h.type === 'ciro' || h.type === 'veresiye_satis')).reduce((a,b)=>a+b.amount,0);
             const count = db.history.filter(h => h.date.startsWith(today)).length;
             cliLog(`TODAY STATS:<br>Sales: ${fmt(sales)}<br>Tx Count: ${count}`, 'info');
             return;
        }

        if (cmd === 'calc') {
            const expr = args.join(' ');
            try {
                if (/[^0-9+\-*/().\s]/.test(expr)) throw new Error('Invalid math expression');
                const res = new Function('return ' + expr)();
                cliLog(`${expr} = ${res}`, 'info');
            } catch(e) { cliLog('Math Error', 'error'); }
            return;
        }

        if (cmd === 'list') {
            const sub = args[0];
            if (sub === 'contacts') {
                if(db.contacts.length === 0) { cliLog("No contacts found.", "warn"); return; }
                const rows = db.contacts.map(c => [c.id, c.name, fmt(c.balance)]);
                cliTable(['ID', 'Name', 'Balance'], rows);
            } else if (sub === 'history') {
                const limit = parseInt(args[1]) || 10;
                if(db.history.length === 0) { cliLog("No history found.", "warn"); return; }
                const rows = db.history.slice(0, limit).map(h => [h.id, h.type, fmt(h.amount), h.desc]);
                cliTable(['ID', 'Type', 'Amt', 'Desc'], rows);
            } else {
                throw new Error('Usage: list contacts | list history [limit]');
            }
            return;
        }

        if (cmd === 'add') {
            const sub = args[0];
            
            if (sub === 'contact') {
                const name = args[1];
                if (!name) throw new Error('Name required.');
                db.contacts.push({ id: Date.now().toString(), name: name, balance: 0 });
                saveDB();
                cliLog(`Contact '${name}' created.`, 'success');
            }
            else if (sub === 'income') {
                const amt = parseFloat(args[1]);
                if (!amt) throw new Error('Amount required.');
                
                let contactId = null;
                let desc = '';
                let idx = 2;

                if (args[idx] === '-v') {
                    const target = args[idx+1];
                    if (!target) throw new Error('Contact name required.');
                    const c = cliFindContact(target);
                    contactId = c.id;
                    idx += 2;
                } else if (args[idx] === '-p') {
                    idx += 1;
                }

                if (args[idx]) desc = args[idx];

                const cost = amt * ((100 - db.profitMargin)/100);

                if (contactId) {
                    const c = db.contacts.find(x=>x.id === contactId);
                    c.balance += amt;
                    db.stock -= cost;
                    addHistory('veresiye_satis', amt, desc || `Satƒ±≈ü: ${c.name}`, cost, c.id);
                    cliLog(`Credit Sale: ${c.name}`, 'success');
                } else {
                    db.cash += amt;
                    db.stock -= cost;
                    addHistory('ciro', amt, desc || 'Pe≈üin Satƒ±≈ü', cost);
                    cliLog('Cash Sale recorded.', 'success');
                }
                saveDB();
            }
            else if (sub === 'buy') {
                const amt = parseFloat(args[1]);
                if (!amt) throw new Error('Amount required.');
                
                let contactId = null;
                let desc = '';
                let idx = 2;

                if (args[idx] === '-v') {
                    const target = args[idx+1];
                    if (!target) throw new Error('Contact name required.');
                    const c = cliFindContact(target);
                    contactId = c.id;
                    idx += 2;
                } else if (args[idx] === '-p') {
                    idx += 1;
                }

                if (args[idx]) desc = args[idx];

                db.stock += amt;

                if (contactId) {
                    const c = db.contacts.find(x=>x.id === contactId);
                    c.balance -= amt;
                    addHistory('mal_cari', amt, desc || `Mal: ${c.name}`, null, c.id);
                    cliLog(`Stock Credit: ${c.name}`, 'success');
                } else {
                    db.cash -= amt;
                    addHistory('mal', amt, desc || 'Mal Alƒ±mƒ± (Pe≈üin)');
                    cliLog('Stock Cash Purchase.', 'success');
                }
                saveDB();
            }
            else if (sub === 'expense') {
                const amt = parseFloat(args[1]);
                const desc = args[2] || 'Gider';
                if (!amt) throw new Error('Amount required.');
                db.cash -= amt;
                addHistory('gider', amt, desc);
                saveDB();
                cliLog(`Expense '${desc}' added.`, 'success');
            } 
            else {
                throw new Error('Unknown add command.');
            }
            return;
        }

        if (cmd === 'pay') {
            const type = args[0]; // give / take
            const target = args[1];
            const amt = parseFloat(args[2]);
            const desc = args[3];
            
            if (!target || !amt) throw new Error('Usage: pay give/take <name> <amount> [desc]');
            const c = cliFindContact(target);
            
            if (type === 'give') {
                db.cash -= amt; c.balance += amt;
                addHistory('cari_cikis', amt, desc || `${c.name} (√ñdeme)`, null, c.id);
                cliLog(`Paid ${fmt(amt)} to ${c.name}`, 'success');
            } else if (type === 'take') {
                db.cash += amt; c.balance -= amt;
                addHistory('cari_giris', amt, desc || `${c.name} (Tahsilat)`, null, c.id);
                cliLog(`Collected ${fmt(amt)} from ${c.name}`, 'success');
            } else {
                throw new Error('Use pay give or pay take');
            }
            saveDB();
            return;
        }

        if (cmd === 'reverse') {
            const id = args[0];
            if(!id) throw new Error('Transaction ID required.');
            const tx = db.history.find(h=>h.id == id);
            if(!tx) throw new Error('Transaction not found.');
            if(tx.isReversed) throw new Error('Already reversed.');
            
            if(confirm(`Reverse tx ${id}?`)) {
                reverseTx(id);
                cliLog('Transaction reversed.', 'success');
            } else {
                cliLog('Cancelled.', 'info');
            }
            return;
        }

        if (cmd === 'del') {
            const sub = args[0];
            const id = args[1];
            if (!id) throw new Error('ID required.');
            
            if (sub === 'contact') {
                db.contacts = db.contacts.filter(x => x.id != id);
                saveDB();
                cliLog(`Contact ${id} deleted.`, 'warn');
            }
            return;
        }

        if (cmd === 'set') {
            const sub = args[0];
            const val = parseFloat(args[1]);
            if (!val) throw new Error('Value required.');
            if (sub === 'stock') { db.stock = val; cliLog(`Stock set to ${val}`, 'success'); }
            else if (sub === 'margin') { db.profitMargin = val; cliLog(`Margin set to ${val}%`, 'success'); }
            else throw new Error('Unknown setting.');
            saveDB();
            return;
        }

        if (cmd === 'backup') {
            const sub = args[0];
            const json = JSON.stringify(db, null, 2);
            if (sub === 'copy') {
                try {
                    await navigator.clipboard.writeText(json);
                    cliLog('Database copied to clipboard.', 'success');
                } catch(e) {
                    cliLog('Clipboard error. Try "backup view"', 'error');
                }
            } else if (sub === 'download') {
                backupDownload();
                cliLog('Download started.', 'success');
            } else if (sub === 'view') {
                cliLog(json, 'info');
            } else {
                throw new Error('Usage: backup copy|download|view');
            }
            resetBackupCounter();
            return;
        }

        if (cmd === 'restore') {
            const input = prompt("Paste your backup JSON here:");
            if (input) {
                processRestoreData(input);
                cliLog('System reloading...', 'warn');
            } else {
                cliLog('Restore cancelled.', 'info');
            }
            return;
        }

        if (cmd === 'reset') {
            if (args[0] === 'yes') {
                localStorage.clear();
                location.reload();
            } else {
                throw new Error('Type "reset yes" to confirm wipe.');
            }
            return;
        }

        throw new Error(`Unknown command: ${cmd}`);

    } catch (err) {
        cliLog(err.message, 'error');
    }
}
</script>

</body></html>
