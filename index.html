<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Esnaf Glass V3</title>
    
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;800&display=swap');
        
        :root {
            --blue: #0A84FF; --green: #30D158; --red: #FF453A;
            --orange: #FF9F0A; --teal: #64D2FF; --yellow: #FFD60A;
            --indigo: #5E5CE6;
            
            --glass-thin: rgba(255, 255, 255, 0.08);
            --glass-border: rgba(255, 255, 255, 0.12);
            --text-primary: #ffffff;
            --text-secondary: rgba(255, 255, 255, 0.6);
            --text-tertiary: rgba(255, 255, 255, 0.35);
            --radius-lg: 24px;
            --safe-bottom: env(safe-area-inset-bottom, 20px);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Inter", sans-serif; }
        
        body { 
            margin: 0; background-color: #000; color: var(--text-primary); 
            min-height: 100vh; padding-bottom: calc(100px + var(--safe-bottom)); 
            overflow-x: hidden; font-size: 16px; user-select: none;
            /* Deep Mesh Gradient */
            background-image: 
                radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), 
                radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%), 
                radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%);
            background-attachment: fixed;
        }

        /* Subtle Drift Animation */
        body::before {
            content: ''; position: fixed; top: -50%; left: -50%; width: 200%; height: 200%;
            background: radial-gradient(circle at 50% 50%, rgba(94, 92, 230, 0.15), transparent 60%),
                        radial-gradient(circle at 80% 20%, rgba(48, 209, 88, 0.1), transparent 50%);
            z-index: -1; animation: drift 20s infinite alternate ease-in-out; pointer-events: none;
        }
        @keyframes drift { 0% { transform: translate(0,0) rotate(0deg); } 100% { transform: translate(-5%, -5%) rotate(5deg); } }

        /* --- GLASS --- */
        .glass {
            background: var(--glass-thin);
            backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
        }
        .glass-heavy {
            background: rgba(28, 28, 30, 0.85);
            backdrop-filter: blur(40px) saturate(180%);
            -webkit-backdrop-filter: blur(40px) saturate(180%);
            border-top: 1px solid rgba(255,255,255,0.15);
        }

        /* --- LAYOUT --- */
        header { 
            height: calc(60px + env(safe-area-inset-top, 0)); 
            padding: env(safe-area-inset-top, 15px) 20px 10px 20px;
            display: flex; justify-content: space-between; align-items: center; 
            position: sticky; top: 0; z-index: 50;
            background: rgba(0,0,0,0.01); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
        }
        .brand { font-weight: 700; font-size: 1.5rem; letter-spacing: -0.5px; background: linear-gradient(135deg, #fff 0%, #a5f3fc 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        .btn-icon { 
            background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.1); 
            color: white; width: 40px; height: 40px; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; 
        }
        .btn-icon:active { transform: scale(0.9); background: rgba(255,255,255,0.2); }

        .container { padding: 20px; max-width: 600px; margin: 0 auto; display: none; animation: fadeIn 0.4s cubic-bezier(0.2, 0.8, 0.2, 1); }
        .container.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }

        /* --- CARDS & LISTS --- */
        .card { border-radius: var(--radius-lg); padding: 24px; margin-bottom: 20px; position: relative; overflow: hidden; transition: transform 0.2s; }
        .card:active { transform: scale(0.99); }
        
        .card-hero { background: linear-gradient(135deg, rgba(94, 92, 230, 0.6) 0%, rgba(10, 132, 255, 0.3) 100%); border: 1px solid rgba(255,255,255,0.2); }
        .hero-lbl { font-size: 0.7rem; font-weight: 600; color: rgba(255,255,255,0.7); letter-spacing: 1px; text-transform: uppercase; margin-bottom: 4px; }
        .hero-val { font-size: 2.8rem; font-weight: 800; letter-spacing: -1.5px; text-shadow: 0 4px 20px rgba(0,0,0,0.3); margin-bottom: 20px; }
        
        .hero-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .stat-box { background: rgba(0,0,0,0.2); border-radius: 16px; padding: 12px; text-align: center; backdrop-filter: blur(10px); }
        .stat-lbl { font-size: 0.7rem; color: rgba(255,255,255,0.6); display: block; margin-bottom: 2px; }
        .stat-val { font-weight: 700; font-size: 1.1rem; }

        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-bottom: 24px; }
        .btn-action { 
            background: var(--glass-thin); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            border: 1px solid var(--glass-border); border-radius: 20px;
            padding: 18px 10px; color: white; display: flex; flex-direction: column; align-items: center; gap: 10px;
            font-size: 0.8rem; font-weight: 500; cursor: pointer; transition: 0.2s; 
        }
        .btn-action:active { transform: scale(0.95); background: rgba(255,255,255,0.15); }
        .btn-action i { font-size: 1.8rem; font-style: normal; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.2)); }

        h3 { font-size: 1.2rem; font-weight: 700; margin: 0 0 15px 0; }
        .list-header { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 15px; padding: 0 4px; }
        .link-btn { color: var(--blue); font-size: 0.9rem; font-weight: 600; cursor: pointer; }

        .tx-row { display: flex; justify-content: space-between; align-items: center; padding: 16px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .tx-row:last-child { border-bottom: none; }
        .tx-icon { width: 48px; height: 48px; border-radius: 16px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; margin-right: 16px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); flex-shrink: 0; }
        .tx-desc { font-weight: 600; font-size: 1rem; margin-bottom: 2px; }
        .tx-meta { font-size: 0.75rem; color: var(--text-tertiary); }
        .tx-amt { font-weight: 700; font-size: 1.1rem; letter-spacing: -0.5px; }

        #contact-search { background: rgba(255,255,255,0.1); border: none; padding: 14px 16px; border-radius: 12px; color: white; font-size: 1rem; width: 100%; backdrop-filter: blur(10px); margin-bottom: 20px; }
        .contact-item { display: flex; justify-content: space-between; align-items: center; padding: 16px; background: var(--glass-thin); border: 1px solid var(--glass-border); border-radius: 18px; margin-bottom: 10px; backdrop-filter: blur(10px); }
        .avatar { width: 42px; height: 42px; background: linear-gradient(135deg, #8E8E93, #636366); border-radius: 50%; display:flex; align-items:center; justify-content:center; font-weight:700; margin-right:12px; font-size:0.9rem; }
        .badge { padding: 6px 10px; border-radius: 8px; font-size: 0.7rem; font-weight: 700; letter-spacing: 0.5px; }
        .badge-green { background: rgba(48, 209, 88, 0.2); color: var(--green); border: 1px solid rgba(48, 209, 88, 0.3); }
        .badge-red { background: rgba(255, 69, 58, 0.2); color: var(--red); border: 1px solid rgba(255, 69, 58, 0.3); }

        /* --- NAV DOCK --- */
        .nav-wrapper { position: fixed; bottom: 25px; left: 0; width: 100%; display: flex; justify-content: center; z-index: 100; pointer-events: none; }
        .nav-dock { pointer-events: auto; background: rgba(40, 40, 40, 0.75); backdrop-filter: blur(25px) saturate(150%); -webkit-backdrop-filter: blur(25px) saturate(150%); border: 1px solid rgba(255,255,255,0.15); border-radius: 32px; padding: 10px 20px; display: flex; gap: 25px; box-shadow: 0 15px 40px rgba(0,0,0,0.4); }
        .nav-item { display: flex; flex-direction: column; align-items: center; cursor: pointer; color: var(--text-tertiary); transition: 0.3s; position: relative; width: 44px; }
        .nav-item span:first-child { font-size: 1.6rem; margin-bottom: 2px; filter: grayscale(100%); transition: 0.3s; }
        .nav-lbl { font-size: 0.6rem; font-weight: 600; opacity: 0; transform: translateY(5px); transition: 0.3s; }
        .nav-item.active { color: white; transform: translateY(-5px); }
        .nav-item.active span:first-child { filter: grayscale(0%); text-shadow: 0 0 15px rgba(255,255,255,0.5); }
        .nav-item.active .nav-lbl { opacity: 1; transform: translateY(0); }
        .fab { position: absolute; top: -30px; left: 50%; transform: translateX(-50%); width: 56px; height: 56px; border-radius: 50%; background: linear-gradient(135deg, var(--blue), var(--indigo)); display: flex; align-items: center; justify-content: center; font-size: 1.8rem; color: white; box-shadow: 0 8px 20px rgba(10, 132, 255, 0.5); border: 2px solid rgba(255,255,255,0.2); cursor: pointer; transition: 0.2s; }
        .fab:active { transform: translateX(-50%) scale(0.9); }

        /* --- DRAGGABLE MODAL SYSTEM --- */
        .modal-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); z-index: 200; 
            display: none; align-items: flex-end; justify-content: center;
            opacity: 0; transition: opacity 0.3s ease; padding-bottom: env(safe-area-inset-bottom, 0);
        }
        .modal-overlay.active { display: flex; opacity: 1; }
        
        .modal { 
            width: 100%; max-width: 600px; max-height: 85vh; 
            display: flex; flex-direction: column;
            border-radius: 32px 32px 0 0; 
            border-top: 1px solid rgba(255,255,255,0.2);
            box-shadow: 0 -10px 50px rgba(0,0,0,0.6);
            transform: translateY(100%);
            transition: transform 0.35s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .modal.open { transform: translateY(0); }
        /* While dragging, we disable CSS transition for instant follow */
        .modal.dragging { transition: none; }

        /* The drag handle zone */
        .drag-handle-zone {
            width: 100%; padding: 20px 0 10px 0; flex-shrink: 0;
            display: flex; justify-content: center; align-items: flex-start;
            cursor: grab; touch-action: none; /* Critical for reliable drag */
        }
        .modal-grabber { width: 40px; height: 5px; background: rgba(255,255,255,0.3); border-radius: 3px; }
        
        .modal-content-scroll {
            overflow-y: auto; padding: 0 24px 40px 24px;
            -ms-overflow-style: none; scrollbar-width: none;
            overscroll-behavior-y: contain;
        }
        .modal-content-scroll::-webkit-scrollbar { display: none; }

        /* --- CONTROLS --- */
        input, select, textarea { width: 100%; padding: 18px; border-radius: 16px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); color: white; font-size: 16px; margin-bottom: 8px; transition: 0.2s; appearance: none; }
        input:focus, select:focus, textarea:focus { background: rgba(0,0,0,0.5); border-color: var(--blue); box-shadow: 0 0 0 4px rgba(10, 132, 255, 0.15); }
        label { color: var(--text-secondary); font-size: 0.85rem; font-weight: 600; margin-left: 5px; margin-bottom: 6px; display: block; }
        
        .btn-main { width: 100%; padding: 18px; border-radius: 18px; border: none; font-weight: 700; font-size: 1.05rem; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; margin-top: 10px; transition: transform 0.1s; flex-shrink: 0; }
        .btn-main:active { transform: scale(0.97); }
        .btn-primary { background: linear-gradient(135deg, #007AFF, #0055FF); color: white; }
        .btn-success { background: linear-gradient(135deg, #34C759, #30B753); color: white; }
        .btn-danger { background: linear-gradient(135deg, #FF3B30, #FF2D55); color: white; }

        .seg-control { background: rgba(0,0,0,0.3); padding: 4px; border-radius: 16px; display: flex; margin-bottom: 24px; flex-shrink: 0; }
        .seg-opt { flex: 1; text-align: center; padding: 10px; font-size: 0.9rem; color: rgba(255,255,255,0.5); border-radius: 12px; transition: 0.2s; font-weight: 600; cursor: pointer; }
        .seg-opt.active { background: rgba(255,255,255,0.15); color: white; box-shadow: 0 2px 8px rgba(0,0,0,0.2); }

        .chips-container { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 15px; }
        .chip { background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.1); color: var(--text-secondary); padding: 8px 16px; border-radius: 20px; font-size: 0.85rem; cursor: pointer; }
        .chip:active { background: var(--blue); color: white; }

        /* Chart */
        .chart-wrapper { margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1); }
        .bar-container { display: flex; align-items: flex-end; justify-content: space-between; height: 120px; }
        .bar-col { flex: 1; display: flex; flex-direction: column; justify-content: flex-end; align-items: center; height: 100%; padding: 0 4px; }
        .bar { width: 80%; background: rgba(255,255,255,0.1); border-radius: 6px; min-height: 6px; transition: height 0.8s; }
        .bar.filled { background: linear-gradient(to top, var(--blue), var(--teal)); box-shadow: 0 0 10px var(--blue); }
        .bar-lbl { font-size: 0.65rem; color: var(--text-tertiary); margin-top: 8px; font-weight: 600; }

        .text-green { color: var(--green); text-shadow: 0 0 10px rgba(48, 209, 88, 0.4); }
        .text-red { color: var(--red); text-shadow: 0 0 10px rgba(255, 69, 58, 0.4); }
        .warning-box { background: rgba(255, 159, 10, 0.15); border: 1px solid rgba(255, 159, 10, 0.4); color: var(--orange); padding: 15px; border-radius: 16px; display: none; align-items: center; gap: 12px; margin-bottom: 20px; }
        .warning-box.active { display: flex; }
        .settings-tabs { display: flex; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 20px; }
        .settings-tab-btn { flex: 1; text-align: center; padding: 12px; font-weight: 600; color: var(--text-tertiary); border-bottom: 2px solid transparent; }
        .settings-tab-btn.active { color: white; border-bottom-color: white; }
        .settings-pane { display: none; }
        .settings-pane.active { display: block; }
    </style>
</head>
<body>

<header>
    <div class="brand">Esnaf Glass V3</div>
    <button class="btn-icon" onclick="openSettings()">
        ‚öôÔ∏è
        <div id="settings-badge" class="notif-badge" style="display:none;"></div>
    </button>
</header>

<div id="view-home" class="container active">
    <div class="card card-hero glass">
        <div class="hero-lbl">NET VARLIK</div>
        <div class="hero-val" id="dash-net">‚Ç∫0</div>
        <div class="hero-stats">
            <div class="stat-box">
                <span class="stat-lbl">KASA</span>
                <span class="stat-val text-green" id="dash-cash">‚Ç∫0</span>
            </div>
            <div class="stat-box" onclick="openEditStock()">
                <span class="stat-lbl">STOK ‚úèÔ∏è</span>
                <span class="stat-val" style="color:var(--teal)" id="dash-stock">‚Ç∫0</span>
            </div>
        </div>
    </div>
    <div class="grid-3">
        <button class="btn-action glass" onclick="openModal('modal-income')"><i style="color:var(--green)">üí∞</i> Satƒ±≈ü</button>
        <button class="btn-action glass" onclick="openModal('modal-buy')"><i style="color:var(--blue)">üì¶</i> Mal Al</button>
        <button class="btn-action glass" onclick="openModal('modal-expense')"><i style="color:var(--red)">üìâ</i> Gider</button>
    </div>
    <div class="card glass">
        <div class="list-header"><h3>Son Hareketler</h3><span class="link-btn" onclick="switchTab('history')">T√ºm√º ‚Ä∫</span></div>
        <div id="recent-list"></div>
    </div>
</div>

<div id="view-contacts" class="container">
    <input type="text" id="contact-search" placeholder="üîç M√º≈üteri ara..." onkeyup="renderContacts()">
    <div id="contact-list"></div>
    <div style="margin-top: 20px;"><button class="btn-main btn-primary" onclick="openModal('modal-add-contact')">+ Yeni Ki≈üi Ekle</button></div>
</div>

<div id="view-history" class="container">
    <div class="list-header"><h3>ƒ∞≈ülem Ge√ßmi≈üi</h3><button class="btn-icon" style="width:auto; padding:0 15px; font-size:0.8rem; border-radius:12px;" onclick="toggleFilter()">üîç Filtre</button></div>
    <div id="filter-box" class="card glass" style="display:none;">
        <div class="grid-3" style="grid-template-columns:1fr 1fr; margin-bottom:12px;">
            <div><label>Ba≈ülangƒ±√ß</label><input type="date" id="f-start"></div>
            <div><label>Biti≈ü</label><input type="date" id="f-end"></div>
        </div>
        <div style="margin-bottom:12px;">
            <label>ƒ∞≈ülem Tipi</label>
            <select id="f-type">
                <option value="all">T√ºm√º</option>
                <option value="ciro">Satƒ±≈ü (Pe≈üin)</option>
                <option value="veresiye_satis">Satƒ±≈ü (Veresiye)</option>
                <option value="gider">Gider</option>
                <option value="mal">Mal Alƒ±mƒ±</option>
            </select>
        </div>
        <div style="margin-bottom:16px;"><label>Ki≈üi / Firma</label><select id="f-contact"><option value="all">Herkes</option></select></div>
        <div style="display:flex; gap:10px;">
            <button class="btn-main btn-primary" onclick="applyFilter()" style="padding:12px;">Uygula</button>
            <button class="btn-main" style="background:rgba(255,255,255,0.1); color:white; padding:12px;" onclick="clearFilter()">Temizle</button>
        </div>
    </div>
    <div id="history-summary" style="display:none; background:rgba(10, 132, 255, 0.15); padding:15px; border-radius:16px; margin-bottom:15px; border:1px solid rgba(10, 132, 255, 0.3);">
        <div style="display:flex; justify-content:space-between; font-weight:700; font-size:1rem; color:var(--blue);">
            <span>Giri≈ü: <span id="sum-in">0</span></span><span>√áƒ±kƒ±≈ü: <span id="sum-out">0</span></span>
        </div>
    </div>
    <div id="full-history-list"></div>
</div>

<div id="view-report" class="container">
    <div class="card glass">
        <div class="list-header"><h3>Bu Ayƒ±n Tahmini</h3><span style="font-size:0.75rem; background:rgba(255, 214, 10, 0.2); color:var(--yellow); padding:4px 8px; border-radius:6px;">Kar Marjƒ±: %<span id="lbl-margin">30</span></span></div>
        <div class="grid-3" style="grid-template-columns:1fr 1fr; gap:15px;">
            <div style="background:rgba(48, 209, 88, 0.1); padding:15px; border-radius:18px; text-align:center;">
                <div style="font-size:0.7rem; font-weight:700; color:var(--green); margin-bottom:5px; text-transform:uppercase;">Ciro</div>
                <div style="font-size:1.1rem; font-weight:800; color:var(--green);" id="rep-ciro">‚Ç∫0</div>
            </div>
            <div style="background:rgba(255, 69, 58, 0.1); padding:15px; border-radius:18px; text-align:center;">
                <div style="font-size:0.7rem; font-weight:700; color:var(--red); margin-bottom:5px; text-transform:uppercase;">Gider</div>
                <div style="font-size:1.1rem; font-weight:800; color:var(--red);" id="rep-exp">‚Ç∫0</div>
            </div>
        </div>
        <div style="text-align:center; margin-top:20px; padding-top:20px; border-top:1px solid rgba(255,255,255,0.1);">
            <div style="font-size:0.85rem; color:var(--text-secondary); font-weight:600;">TAHMƒ∞Nƒ∞ NET KAR</div>
            <div style="font-size: 2.4rem; font-weight: 900; letter-spacing: -1px; color: var(--text-primary); text-shadow:0 0 20px rgba(255,255,255,0.3);" id="rep-net">‚Ç∫0</div>
        </div>
        <div class="chart-wrapper"><div class="bar-container" id="weekly-chart"></div></div>
    </div>
    <div class="card glass">
        <h3 style="margin:0 0 15px 0; font-size:1.1rem;">Piyasa Durumu</h3>
        <div class="tx-row"><span>Alacaklar (Piyasa)</span><span class="text-green" style="font-size:1.1rem; font-weight:700;" id="rep-rec">‚Ç∫0</span></div>
        <div class="tx-row"><span>Bor√ßlar (Tedarik√ßi)</span><span class="text-red" style="font-size:1.1rem; font-weight:700;" id="rep-debt">‚Ç∫0</span></div>
    </div>
</div>

<div class="nav-wrapper">
    <div class="nav-dock glass-heavy">
        <div class="nav-item active" onclick="switchTab('home', this)"><span>üè†</span><span class="nav-lbl">√ñzet</span></div>
        <div class="nav-item" onclick="switchTab('contacts', this)"><span>üë•</span><span class="nav-lbl">Ki≈üiler</span></div>
        <div style="width:20px;"><div class="fab" onclick="openModal('modal-income')">+</div></div>
        <div class="nav-item" onclick="switchTab('history', this)"><span>üìú</span><span class="nav-lbl">Ge√ßmi≈ü</span></div>
        <div class="nav-item" onclick="switchTab('report', this)"><span>üìä</span><span class="nav-lbl">Analiz</span></div>
    </div>
</div>

<!-- MODAL TEMPLATE STRUCTURE -->
<div id="modal-income" class="modal-overlay">
    <div class="modal glass-heavy">
        <div class="drag-handle-zone"><div class="modal-grabber"></div></div>
        <div class="modal-content-scroll">
            <h3>üí∞ Satƒ±≈ü / Giri≈ü</h3>
            <div class="seg-control">
                <div class="seg-opt active" onclick="setIncomeType('ciro', this)">√úr√ºn Satƒ±≈üƒ±</div>
                <div class="seg-opt" onclick="setIncomeType('sermaye', this)">Kasa Ekle</div>
            </div>
            <label>Tutar (‚Ç∫)</label>
            <input type="number" id="inp-inc-amt" placeholder="0" style="font-size:2rem; text-align:center; font-weight:800; color:var(--green); margin-bottom:20px; background:transparent; border:none; border-bottom:1px solid rgba(255,255,255,0.2);" inputmode="decimal">
            <div id="inc-details">
                <label>√ñdeme Tipi</label>
                <select id="inp-inc-method" onchange="toggleContactSelect('inc', this.value)">
                    <option value="pesin">Pe≈üin (Nakit / Kredi Kartƒ±)</option>
                    <option value="veresiye">Veresiye (Ki≈üi Se√ß)</option>
                </select>
                <div id="div-inc-contact" style="display:none; margin-top:15px;">
                    <label>M√º≈üteri Se√ßiniz</label>
                    <select id="inp-inc-contact"><option value="">Se√ßiniz...</option></select>
                </div>
            </div>
            <button class="btn-main btn-success" style="margin-top:24px;" onclick="saveIncome()">Gƒ∞Rƒ∞≈ûƒ∞ KAYDET</button>
        </div>
    </div>
</div>

<div id="modal-buy" class="modal-overlay">
    <div class="modal glass-heavy">
        <div class="drag-handle-zone"><div class="modal-grabber"></div></div>
        <div class="modal-content-scroll">
            <h3>üì¶ Mal Alƒ±mƒ±</h3>
            <label>Tutar (‚Ç∫)</label>
            <input type="number" id="inp-buy-amt" placeholder="0" style="font-size:2rem; text-align:center; font-weight:800; color:var(--blue); margin-bottom:20px; background:transparent; border:none; border-bottom:1px solid rgba(255,255,255,0.2);" inputmode="decimal">
            <label>√ñdeme ≈ûekli</label>
            <select id="inp-buy-method" onchange="toggleContactSelect('buy', this.value)">
                <option value="pesin">Pe≈üin (Kasadan √ñde)</option>
                <option value="veresiye">Veresiye (Borca Yaz)</option>
            </select>
            <div id="div-buy-contact" style="display:none; margin-top:15px;"><label>Tedarik√ßi Se√ßiniz</label><select id="inp-buy-contact"><option value="">Se√ßiniz...</option></select></div>
            <button class="btn-main btn-primary" style="margin-top:24px;" onclick="saveBuy()">STOK EKLE</button>
        </div>
    </div>
</div>

<div id="modal-expense" class="modal-overlay">
    <div class="modal glass-heavy">
        <div class="drag-handle-zone"><div class="modal-grabber"></div></div>
        <div class="modal-content-scroll">
            <h3>üìâ Gider √áƒ±kƒ±≈üƒ±</h3>
            <label>Tutar (‚Ç∫)</label>
            <input type="number" id="inp-exp-amt" placeholder="0" style="font-size:2rem; text-align:center; font-weight:800; color:var(--red); margin-bottom:20px; background:transparent; border:none; border-bottom:1px solid rgba(255,255,255,0.2);" inputmode="decimal">
            <label>A√ßƒ±klama</label>
            <div id="expense-chips" class="chips-container"></div>
            <input type="text" id="inp-exp-desc" placeholder="Kira, Fatura vb." list="expense-suggestions" autocomplete="off">
            <datalist id="expense-suggestions"></datalist>
            <button class="btn-main btn-danger" style="margin-top:24px;" onclick="saveExpense()">KAYDET</button>
        </div>
    </div>
</div>

<div id="modal-add-contact" class="modal-overlay">
    <div class="modal glass-heavy">
        <div class="drag-handle-zone"><div class="modal-grabber"></div></div>
        <div class="modal-content-scroll">
            <h3>Yeni Ki≈üi / Firma</h3>
            <label>Ad Soyad / Firma √únvanƒ±</label>
            <input type="text" id="inp-c-name" placeholder="√ñrn: Toptancƒ± Ahmet">
            <button class="btn-main btn-primary" style="margin-top:24px;" onclick="addContact()">OLU≈ûTUR</button>
        </div>
    </div>
</div>

<div id="modal-contact-op" class="modal-overlay">
    <div class="modal glass-heavy">
        <div class="drag-handle-zone"><div class="modal-grabber"></div></div>
        <div class="modal-content-scroll">
            <h3 id="op-c-name" style="text-align:center; margin-bottom:5px;"></h3>
            <div id="op-c-bal" style="text-align:center; font-weight:800; font-size:1.4rem; margin-bottom:24px;"></div>
            <button class="btn-action" style="width:100%; margin-bottom:24px; flex-direction:row; justify-content:center; padding:12px; background:rgba(255,255,255,0.05);" onclick="showContactHistoryFromModal()"><span>üìú</span> Bu Ki≈üinin Hesap D√∂k√ºm√º (Ekstre)</button>
            <div style="background:rgba(255,255,255,0.05); padding:15px; border-radius:16px; margin-bottom:20px;">
                <label style="text-align:center;">ƒ∞≈ülem Tutarƒ±</label>
                <input type="number" id="inp-op-amt" style="text-align:center; font-size:1.5rem; background:transparent; border:none;" inputmode="decimal" placeholder="0">
            </div>
            <div class="grid-3" style="grid-template-columns:1fr 1fr; gap:15px;">
                <button class="btn-main" style="background:var(--orange); color:white;" onclick="doContactOp('give')">Bor√ß Ver<br><small>(√ñdeme)</small></button>
                <button class="btn-main btn-success" onclick="doContactOp('take')">Tahsilat<br><small>(Bor√ß Al)</small></button>
            </div>
            <button class="btn-main" style="margin-top:20px; background:rgba(255,59,48,0.2); color:var(--red);" onclick="deleteContact()">Ki≈üiyi Sil</button>
        </div>
    </div>
</div>

<div id="modal-stock-edit" class="modal-overlay">
    <div class="modal glass-heavy">
        <div class="drag-handle-zone"><div class="modal-grabber"></div></div>
        <div class="modal-content-scroll">
            <h3>Stok Deƒüeri D√ºzenle</h3>
            <p style="font-size:0.9rem; color:var(--text-secondary); margin-bottom:15px;">G√ºncel stok maliyet deƒüerini giriniz.</p>
            <input type="number" id="inp-stock-val" inputmode="decimal" style="font-size:1.5rem; text-align:center; font-weight:bold;">
            <button class="btn-main btn-primary" style="margin-top:24px;" onclick="updateStockVal()">G√úNCELLE</button>
        </div>
    </div>
</div>

<div id="modal-settings" class="modal-overlay">
    <div class="modal glass-heavy">
        <div class="drag-handle-zone"><div class="modal-grabber"></div></div>
        <div class="modal-content-scroll">
            <h3>Ayarlar</h3>
            <div class="settings-tabs">
                <div class="settings-tab-btn active" onclick="switchSettingsTab('genel', this)">Genel</div>
                <div class="settings-tab-btn" onclick="switchSettingsTab('yedek', this)">Yedekleme</div>
                <div class="settings-tab-btn" onclick="switchSettingsTab('sistem', this)">Sistem</div>
            </div>
            <div id="pane-genel" class="settings-pane active">
                <button class="btn-main" style="background:rgba(255,255,255,0.1); font-size:0.9rem; margin-bottom:20px;" onclick="showInstallHelp()">üì≤ Ana Ekrana Nasƒ±l Eklenir?</button>
                <div style="margin-bottom:20px;"><label>Ortalama Kar Marjƒ± (%)</label><input type="number" id="inp-settings-margin" placeholder="30"></div>
                <div style="margin-bottom:10px;"><label>‚ö†Ô∏è Yedekleme Hatƒ±rlatƒ±cƒ±sƒ±</label><select id="inp-settings-reminder"><option value="0">Kapalƒ±</option><option value="10">Her 10 ƒ∞≈ülemde Bir</option><option value="20">Her 20 ƒ∞≈ülemde Bir</option></select></div>
                <button class="btn-main btn-primary" style="margin-top:15px;" onclick="saveSettings()">AYARLARI KAYDET</button>
            </div>
            <div id="pane-yedek" class="settings-pane">
                 <div id="backup-warning" class="warning-box"><span>‚ö†Ô∏è</span><div><b>Yedek Almalƒ±sƒ±n!</b><br>Son yedekten beri <span id="backup-count-lbl">0</span> i≈ülem.</div></div>
                <button class="btn-action" style="width:100%; margin-bottom:15px; flex-direction:row; justify-content:center;" onclick="backupToClipboard()">üìã T√ºm Veriyi Kopyala</button>
                <div class="grid-3" style="grid-template-columns:1fr 1fr; gap:10px;">
                    <button class="btn-action" onclick="backupDownload()">üíæ ƒ∞ndir</button>
                    <div style="position:relative;" class="btn-action"><span>üìÇ Y√ºkle</span><input type="file" onchange="restoreBackup(this)" accept=".json,.txt" style="opacity:0; position:absolute; top:0; left:0; width:100%; height:100%;"></div>
                </div>
                <textarea id="restore-text-area" rows="3" placeholder="Yedekleme metnini buraya yapƒ±≈ütƒ±r..." style="width:100%; padding:10px; font-size:0.8rem; margin-top:10px;"></textarea>
                <button class="btn-main btn-success" style="margin-top:10px;" onclick="restoreFromText()">üì• Metni Y√ºkle</button>
            </div>
            <div id="pane-sistem" class="settings-pane">
                <button class="btn-main" style="background:rgba(255,255,255,0.1); margin-bottom:20px;" onclick="downloadAppSource()">üì• Uygulamayƒ± ƒ∞ndir (.html)</button>
                <button class="btn-main btn-danger" onclick="hardReset()">VERƒ∞LERƒ∞ SIFIRLA</button>
            </div>
        </div>
    </div>
</div>

<script>
/* --- CORE LOGIC --- */
let db={cash:0,stock:0,profitMargin:30,contacts:[],history:[],txCount:0,backupLimit:10},tempIncomeType='ciro',selectedCId=null;
window.onload=()=>{const s=localStorage.getItem('esnaf_v4_db');if(s)try{db=JSON.parse(s)}catch(e){}if(!db.profitMargin)db.profitMargin=30;if(db.txCount===undefined)db.txCount=0;initApp();initSwipeGestures();};
function initApp(){if(!Array.isArray(db.contacts))db.contacts=[];if(!Array.isArray(db.history))db.history=[];updateUI();}
function saveDB(){localStorage.setItem('esnaf_v4_db',JSON.stringify(db));updateUI();}
function updateUI(){checkBackupStatus();const tr=db.contacts.reduce((a,c)=>a+(c.balance>0?c.balance:0),0),td=db.contacts.reduce((a,c)=>a+(c.balance<0?Math.abs(c.balance):0),0),n=db.cash+db.stock+tr-td;document.getElementById('dash-net').innerText=fmt(n);document.getElementById('dash-cash').innerText=fmt(db.cash);document.getElementById('dash-stock').innerText=fmt(db.stock);document.getElementById('lbl-margin').innerText=db.profitMargin;
const now=new Date(),days=[];for(let i=6;i>=0;i--){const d=new Date();d.setDate(now.getDate()-i);days.push({date:d.toISOString().slice(0,10),label:d.toLocaleDateString('tr-TR',{weekday:'short'}),val:0});}
let mc=0,me=0,mg=0;const cm=now.toISOString().slice(0,7);db.history.forEach(h=>{if(h.date.startsWith(cm)){if(h.type==='ciro'||h.type==='veresiye_satis'){mc+=h.amount;mg+=h.cost||(h.amount*((100-db.profitMargin)/100));}if(h.type==='gider')me+=h.amount;}if(h.type==='ciro'||h.type==='veresiye_satis'){const dx=days.findIndex(d=>d.date===h.date.slice(0,10));if(dx>-1)days[dx].val+=h.amount;}});
document.getElementById('rep-ciro').innerText=fmt(mc);document.getElementById('rep-exp').innerText=fmt(me);const np=(mc-mg)-me;const ne=document.getElementById('rep-net');ne.innerText=fmt(np);ne.style.color=np>=0?'var(--green)':'var(--red)';document.getElementById('rep-rec').innerText=fmt(tr);document.getElementById('rep-debt').innerText=fmt(td);drawChart(days);
const rd=document.getElementById('recent-list');rd.innerHTML=db.history.length?'':'<div class="empty-state">Hen√ºz i≈ülem yok.</div>';db.history.slice(0,5).forEach(h=>rd.innerHTML+=createHistoryRow(h));populateSelects();if(document.getElementById('view-history').classList.contains('active'))applyFilter();}
function populateSelects(){const o='<option value="">Se√ßiniz...</option>'+db.contacts.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');document.getElementById('inp-inc-contact').innerHTML=o;document.getElementById('inp-buy-contact').innerHTML=o;document.getElementById('f-contact').innerHTML='<option value="all">Herkes</option>'+db.contacts.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');}
function drawChart(d){const m=Math.max(...d.map(x=>x.val),1);document.getElementById('weekly-chart').innerHTML=d.map(x=>`<div class="bar-col"><div class="bar ${x.val>0?'filled':''}" style="height:${(x.val/m)*100}%;"></div><div class="bar-lbl">${x.label}</div></div>`).join('');}
function saveIncome(){const a=getNum('inp-inc-amt');if(a<=0)return;if(tempIncomeType==='ciro'){const c=a*((100-db.profitMargin)/100);db.stock-=c;const m=document.getElementById('inp-inc-method').value;if(m==='pesin'){db.cash+=a;addHistory('ciro',a,'Pe≈üin Satƒ±≈ü',c);}else{const i=document.getElementById('inp-inc-contact').value;if(!i)return;const k=db.contacts.find(x=>x.id===i);k.balance+=a;addHistory('veresiye_satis',a,`Satƒ±≈ü: ${k.name}`,c,i);}}else{db.cash+=a;addHistory('sermaye',a,'Sermaye Giri≈üi');}closeModal(document.querySelector('.modal-overlay.active').id);saveDB();}
function saveBuy(){const a=getNum('inp-buy-amt');if(a<=0)return;db.stock+=a;const m=document.getElementById('inp-buy-method').value;if(m==='pesin'){db.cash-=a;addHistory('mal',a,'Mal Alƒ±mƒ± (Pe≈üin)');}else{const i=document.getElementById('inp-buy-contact').value;if(!i)return;const k=db.contacts.find(x=>x.id===i);k.balance-=a;addHistory('mal_cari',a,`Mal Alƒ±mƒ±: ${k.name}`,null,i);}closeModal(document.querySelector('.modal-overlay.active').id);saveDB();}
function saveExpense(){const a=getNum('inp-exp-amt');if(a<=0)return;db.cash-=a;addHistory('gider',a,document.getElementById('inp-exp-desc').value||'Gider');closeModal(document.querySelector('.modal-overlay.active').id);saveDB();}
function addContact(){const n=document.getElementById('inp-c-name').value.trim();if(!n)return;db.contacts.push({id:Date.now().toString(),name:n,balance:0});closeModal('modal-add-contact');saveDB();renderContacts();}
function renderContacts(){const l=document.getElementById('contact-list'),t=(document.getElementById('contact-search').value||'').toLowerCase();l.innerHTML='';[...db.contacts].sort((a,b)=>Math.abs(b.balance)-Math.abs(a.balance)).forEach(c=>{if(t&&!c.name.toLowerCase().includes(t))return;let b=c.balance>0?`<span class="badge badge-green">ALACAK: ${fmt(c.balance)}</span>`:(c.balance<0?`<span class="badge badge-red">BOR√á: ${fmt(Math.abs(c.balance))}</span>`:`<span class="badge" style="background:rgba(255,255,255,0.1)">TEMƒ∞Z</span>`);l.innerHTML+=`<div class="contact-item" onclick="openContactModal('${c.id}')"><div style="display:flex; align-items:center;"><div class="avatar">${c.name.charAt(0).toUpperCase()}</div><span style="font-weight:600;">${c.name}</span></div>${b}</div>`;});}
function doContactOp(t){const a=getNum('inp-op-amt');if(a<=0)return;const c=db.contacts.find(x=>x.id===selectedCId);if(t==='give'){db.cash-=a;c.balance+=a;addHistory('cari_cikis',a,`${c.name} (√ñdeme)`,null,c.id);}else{db.cash+=a;c.balance-=a;addHistory('cari_giris',a,`${c.name} (Tahsilat)`,null,c.id);}closeModal('modal-contact-op');saveDB();}
function createHistoryRow(h,d=false){const p=['ciro','sermaye','cari_giris','veresiye_satis'].includes(h.type),c=p?'var(--green)':'var(--red)',i={'ciro':'üí∞','sermaye':'üè¶','gider':'üìâ','mal':'üì¶','mal_cari':'üöõ','veresiye_satis':'üìù','cari_giris':'üíµ','cari_cikis':'üí∏'}[h.type]||'üîπ',b=d?`<button onclick="deleteTx(${h.id})" style="margin-left:10px; background:rgba(255,69,58,0.2); border:none; border-radius:8px; width:30px; height:30px;">üóëÔ∏è</button>`:'';return `<div class="tx-row"><div style="display:flex; align-items:center;"><div class="tx-icon">${i}</div><div><div class="tx-desc">${h.desc}</div><div class="tx-meta">${new Date(h.date).toLocaleDateString()}</div></div></div><div style="display:flex; align-items:center;"><span class="tx-amt" style="color:${c}">${p?'+':'-'}${fmt(h.amount)}</span>${b}</div></div>`;}
function openModal(id){document.querySelectorAll(`#${id} input`).forEach(e=>e.value='');if(document.querySelector(`#${id} select`))document.querySelector(`#${id} select`).selectedIndex=0;['div-inc-contact','div-buy-contact'].forEach(d=>{if(document.getElementById(d))document.getElementById(d).style.display='none'});document.getElementById(id).classList.add('active');setTimeout(()=>document.querySelector(`#${id} .modal`).classList.add('open'),10);if(id==='modal-expense')updateExpenseSuggestions();if(id==='modal-settings'){document.getElementById('inp-settings-margin').value=db.profitMargin;document.getElementById('inp-settings-reminder').value=db.backupLimit||10;}}
function closeModal(id){document.querySelector(`#${id} .modal`).classList.remove('open');document.querySelector(`#${id}`).style.opacity='0';setTimeout(()=>{document.getElementById(id).classList.remove('active');document.getElementById(id).style.opacity='';},300);}
function getNum(id){return parseFloat(document.getElementById(id).value)||0;}
function fmt(n){return new Intl.NumberFormat('tr-TR',{style:'currency',currency:'TRY',maximumFractionDigits:0}).format(n);}
function addHistory(t,a,d,c=null,i=null){db.history.unshift({id:Date.now(),date:new Date().toISOString(),type:t,amount:a,desc:d,cost:c,contactId:i});db.txCount=(db.txCount||0)+1;}
function updateExpenseSuggestions(){const c=document.getElementById('expense-chips');c.innerHTML='';['Kira','Fatura','Yemek','Yol','Malzeme'].forEach(t=>c.innerHTML+=`<div class="chip" onclick="document.getElementById('inp-exp-desc').value='${t}'">${t}</div>`);}
function switchTab(i,e){document.querySelectorAll('.container').forEach(c=>c.classList.remove('active'));document.getElementById('view-'+i).classList.add('active');document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));if(e)e.classList.add('active');if(i==='contacts'){document.getElementById('contact-search').value='';renderContacts();}if(i==='history')applyFilter();window.scrollTo(0,0);}
function switchSettingsTab(p,b){document.querySelectorAll('.settings-pane').forEach(x=>x.classList.remove('active'));document.getElementById('pane-'+p).classList.add('active');document.querySelectorAll('.settings-tab-btn').forEach(x=>x.classList.remove('active'));b.classList.add('active');}
function openContactModal(i){selectedCId=i;const c=db.contacts.find(x=>x.id===i);document.getElementById('op-c-name').innerText=c.name;const e=document.getElementById('op-c-bal');e.innerText=fmt(c.balance);e.style.color=c.balance>0?'var(--green)':(c.balance<0?'var(--red)':'white');openModal('modal-contact-op');}
function showContactHistoryFromModal(){closeModal('modal-contact-op');document.getElementById('f-contact').value=selectedCId;document.getElementById('filter-box').style.display='block';switchTab('history');}
function deleteContact(){if(confirm('Silinsin mi?')){db.contacts=db.contacts.filter(x=>x.id!==selectedCId);saveDB();closeModal('modal-contact-op');renderContacts();}}
function openEditStock(){document.getElementById('inp-stock-val').value=db.stock;openModal('modal-stock-edit');}
function updateStockVal(){db.stock=getNum('inp-stock-val');saveDB();closeModal('modal-stock-edit');}
function openSettings(){openModal('modal-settings');}
function saveSettings(){db.profitMargin=getNum('inp-settings-margin');db.backupLimit=parseInt(document.getElementById('inp-settings-reminder').value);saveDB();closeModal('modal-settings');}
function hardReset(){if(confirm('Her ≈üey silinecek!')){localStorage.clear();location.reload();}}
function checkBackupStatus(){const w=document.getElementById('backup-warning'),b=document.getElementById('settings-badge');document.getElementById('backup-count-lbl').innerText=db.txCount;if(db.backupLimit>0&&db.txCount>=db.backupLimit){w.classList.add('active');b.style.display='flex';}else{w.classList.remove('active');b.style.display='none';}}
async function backupToClipboard(){await navigator.clipboard.writeText(JSON.stringify(db));db.txCount=0;saveDB();alert('Kopyalandƒ±!');}
function backupDownload(){const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([JSON.stringify(db)],{type:'application/json'}));a.download='esnaf_yedek.json';a.click();db.txCount=0;saveDB();}
function restoreBackup(i){const r=new FileReader();r.onload=e=>{try{db=JSON.parse(e.target.result);saveDB();alert('Y√ºklendi!');location.reload();}catch(x){alert('Hata');}};r.readAsText(i.files[0]);}
function restoreFromText(){try{db=JSON.parse(document.getElementById('restore-text-area').value);saveDB();alert('Y√ºklendi!');location.reload();}catch(x){alert('Hata');}}
function showInstallHelp(){alert('IOS: Payla≈ü -> Ana Ekrana Ekle\nAndroid: Men√º -> Ana Ekrana Ekle');}
function downloadAppSource(){const a=document.createElement('a');a.href=URL.createObjectURL(new Blob(["<!DOCTYPE html>\n"+document.documentElement.outerHTML],{type:"text/html"}));a.download="esnaf_glass_v3.html";a.click();}
function setIncomeType(t,e){tempIncomeType=t;document.querySelectorAll('.seg-opt').forEach(s=>s.classList.remove('active'));e.classList.add('active');document.getElementById('inc-details').style.display=t==='ciro'?'block':'none';}
function toggleContactSelect(c,v){document.getElementById(`div-${c}-contact`).style.display=v==='veresiye'?'block':'none';}
function toggleFilter(){const f=document.getElementById('filter-box');f.style.display=f.style.display==='none'?'block':'none';}
function applyFilter(){const s=document.getElementById('f-start').value,e=document.getElementById('f-end').value,t=document.getElementById('f-type').value,c=document.getElementById('f-contact').value;let l=[...db.history];if(s)l=l.filter(h=>h.date.slice(0,10)>=s);if(e)l=l.filter(h=>h.date.slice(0,10)<=e);if(t!=='all')l=l.filter(h=>h.type===t);if(c!=='all')l=l.filter(h=>h.contactId===c);l.sort((a,b)=>new Date(b.date)-new Date(a.date));const o=document.getElementById('full-history-list');o.innerHTML=l.length?'':'<div class="empty-state">Kayƒ±t yok.</div>';let i=0,ot=0;l.forEach(h=>{if(['ciro','sermaye','cari_giris','veresiye_satis'].includes(h.type))i+=h.amount;else ot+=h.amount;o.innerHTML+=createHistoryRow(h,true);});document.getElementById('sum-in').innerText=fmt(i);document.getElementById('sum-out').innerText=fmt(ot);document.getElementById('history-summary').style.display='block';}
function clearFilter(){document.getElementById('f-start').value='';document.getElementById('f-end').value='';document.getElementById('f-type').value='all';document.getElementById('f-contact').value='all';applyFilter();}
function deleteTx(id){if(!confirm('Silinsin mi?'))return;const x=db.history.findIndex(h=>h.id===id);if(x===-1)return;const h=db.history[x];if(h.type==='ciro'){db.cash-=h.amount;if(h.cost)db.stock+=h.cost;}else if(h.type==='veresiye_satis'&&h.contactId){const c=db.contacts.find(k=>k.id===h.contactId);if(c)c.balance-=h.amount;if(h.cost)db.stock+=h.cost;}else if(h.type==='gider')db.cash+=h.amount;else if(h.type==='mal'){db.stock-=h.amount;db.cash+=h.amount;}else if(h.type==='mal_cari'&&h.contactId){db.stock-=h.amount;const c=db.contacts.find(k=>k.id===h.contactId);if(c)c.balance+=h.amount;}else if(h.type==='cari_giris'&&h.contactId){db.cash-=h.amount;const c=db.contacts.find(k=>k.id===h.contactId);if(c)c.balance+=h.amount;}else if(h.type==='cari_cikis'&&h.contactId){db.cash+=h.amount;const c=db.contacts.find(k=>k.id===h.contactId);if(c)c.balance-=h.amount;}db.history.splice(x,1);saveDB();if(document.getElementById('view-history').classList.contains('active'))applyFilter();}

/* --- NEW SWIPE LOGIC --- */
function initSwipeGestures() {
    const handles = document.querySelectorAll('.drag-handle-zone');
    handles.forEach(h => {
        let startY = 0;
        let currentModal = null;
        let overlay = null;

        h.addEventListener('touchstart', (e) => {
            startY = e.touches[0].clientY;
            currentModal = h.closest('.modal');
            overlay = h.closest('.modal-overlay');
            currentModal.classList.add('dragging');
        }, {passive: true});

        h.addEventListener('touchmove', (e) => {
            if(!currentModal) return;
            const deltaY = e.touches[0].clientY - startY;
            if(deltaY > 0) {
                // Move modal
                currentModal.style.transform = `translateY(${deltaY}px)`;
                // Fade overlay based on distance (max 300px)
                const opacity = Math.max(0, 1 - (deltaY / 400));
                overlay.style.backgroundColor = `rgba(0,0,0,${0.5 * opacity})`;
            }
        }, {passive: true});

        h.addEventListener('touchend', (e) => {
            if(!currentModal) return;
            const deltaY = e.changedTouches[0].clientY - startY;
            currentModal.classList.remove('dragging');
            currentModal.style.transform = ''; // allow CSS transition to take over
            overlay.style.backgroundColor = '';

            if(deltaY > 120) {
                // Close it
                closeModal(overlay.id);
            } else {
                // Snap back
                currentModal.classList.add('open'); // Ensure class stays
            }
            currentModal = null;
            overlay = null;
        });
    });
    
    // Close on overlay click
    document.querySelectorAll('.modal-overlay').forEach(o => {
        o.addEventListener('click', (e) => {
            if(e.target === o) closeModal(o.id);
        });
    });
}
</script>
</body>
</html>

